<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒ†ãƒ³ãƒ¬ã‚¹é‹³é€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - å®Œå…¨ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .urgent-row { background-color: #fff2cc !important; }
        .s14-material { border-left: 4px solid #007bff; }
        .scs-material { border-left: 4px solid #28a745; }
        .sus304-material { border-left: 4px solid #ffc107; }
        .chat-container { max-height: 300px; overflow-y: auto; }
        .message-user { background: #007bff; color: white; padding: 8px 12px; border-radius: 18px; margin: 5px 0; max-width: 80%; margin-left: auto; }
        .message-ai { background: #f8f9fa; border: 1px solid #dee2e6; padding: 8px 12px; border-radius: 18px; margin: 5px 0; max-width: 80%; }
        .processing { opacity: 0.6; pointer-events: none; }
        .material-s14 { color: #007bff; font-weight: bold; }
        .material-scs { color: #28a745; font-weight: bold; }
        .material-sus304 { color: #ffc107; font-weight: bold; }
        .status-urgent { background: linear-gradient(45deg, #ff6b6b, #ffa500) !important; color: white; }
        .batch-result { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 8px; margin: 10px 0; }
        
        /* PDFè‡ªå‹•å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .auto-filled {
            background-color: #e8f4f8 !important;
            border-left: 3px solid #17a2b8 !important;
            transition: all 0.3s ease;
        }
        
        .auto-filled:focus {
            background-color: #ffffff !important;
            box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25) !important;
        }
        
        .form-control.is-valid {
            border-color: #198754;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='m2.3 6.73.4.4c.2.2.6.2.8 0l3.1-3.1c.2-.2.2-.6 0-.8L5.6 2.22c-.2-.2-.6-.2-.8 0l-1.8 1.8L1.7 2.7c-.2-.2-.6-.2-.8 0L.22 3.4c-.2.2-.2.6 0 .8l2.08 2.53z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        .form-control.is-invalid {
            border-color: #dc3545;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m6 3v3m0 2h.01'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        .extraction-summary {
            animation: slideIn 0.5s ease-in-out;
        }
        
        .data-preview-table th {
            width: 30%;
            font-weight: 600;
            color: #495057;
        }
        
        .data-preview-table td {
            color: #6c757d;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .progress-animated .progress-bar {
            animation: progressFill 1s ease-in-out;
        }
        
        @keyframes progressFill {
            from { width: 0%; }
            to { width: var(--progress-width); }
        }
    </style>
    
    <script>
        // === AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼‰ ===
        let isProcessing = false;
        let orders = [];
        let filteredOrders = [];
        
        // ã‚¯ã‚¤ãƒƒã‚¯ã‚¯ã‚¨ãƒªæŒ¿å…¥
        function insertQuickQuery(query) {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.value = query;
            }
        }

        // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        async function sendChatMessage() {
            if (isProcessing) return;

            const input = document.getElementById('chatInput');
            const message = input ? input.value.trim() : '';
            
            if (!message) {
                alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            addMessageToChat(message, 'user');
            input.value = '';
            
            // å‡¦ç†ä¸­çŠ¶æ…‹ã«è¨­å®š
            setProcessingState(true);

            try {
                // è‡ªç„¶è¨€èªã§ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ã‚’å®Ÿè¡Œ
                const searchResult = await processNaturalLanguageQuery(message);
                
                // AI APIã‚’å‘¼ã³å‡ºã—
                const aiResponse = await callAIAPI(message, searchResult);
                
                // AIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¡¨ç¤º
                addMessageToChat(aiResponse, 'ai');
                
            } catch (error) {
                console.error('AIå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                addMessageToChat('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'ai');
            } finally {
                setProcessingState(false);
            }
        }

        // Enter ã‚­ãƒ¼å‡¦ç†
        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        // ãƒãƒ£ãƒƒãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
        function addMessageToChat(message, type) {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'user' ? 'message-user' : 'message-ai';
            messageDiv.innerHTML = message.replace(/\n/g, '<br>');
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // å‡¦ç†ä¸­çŠ¶æ…‹ã®è¨­å®š
        function setProcessingState(processing) {
            isProcessing = processing;
            const sendButton = document.getElementById('sendButton');
            const chatInput = document.getElementById('chatInput');
            
            if (processing) {
                if (sendButton) {
                    sendButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> å‡¦ç†ä¸­...';
                    sendButton.disabled = true;
                }
                if (chatInput) {
                    chatInput.disabled = true;
                }
                addMessageToChat('<div class="text-muted"><i class="bi bi-hourglass-split"></i> AIãŒå›ç­”ã‚’ç”Ÿæˆä¸­...</div>', 'ai');
            } else {
                if (sendButton) {
                    sendButton.innerHTML = '<i class="bi bi-send"></i> é€ä¿¡';
                    sendButton.disabled = false;
                }
                if (chatInput) {
                    chatInput.disabled = false;
                }
                // å‡¦ç†ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
                const messages = document.querySelectorAll('.message-ai');
                const lastMessage = messages[messages.length - 1];
                if (lastMessage && lastMessage.innerHTML.includes('hourglass-split')) {
                    lastMessage.remove();
                }
            }
        }

        // è‡ªç„¶è¨€èªã‚¯ã‚¨ãƒªå‡¦ç†
        async function processNaturalLanguageQuery(query) {
            const normalizedQuery = query.toLowerCase();
            let filteredData = [...orders];
            let searchResults = {
                data: filteredData,
                summary: '',
                filters: []
            };

            try {
                // æè³ªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                if (normalizedQuery.includes('s14')) {
                    filteredData = filteredData.filter(order => order.material === 'S14');
                    searchResults.filters.push('S14æ');
                } else if (normalizedQuery.includes('scs')) {
                    filteredData = filteredData.filter(order => order.material === 'SCS');
                    searchResults.filters.push('SCSæ');
                } else if (normalizedQuery.includes('sus304')) {
                    filteredData = filteredData.filter(order => order.material === 'SUS304');
                    searchResults.filters.push('SUS304æ');
                }

                // ç·Šæ€¥æ¡ˆä»¶ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                if (normalizedQuery.includes('ç·Šæ€¥') || normalizedQuery.includes('æ€¥ã')) {
                    const urgentOrders = filteredData.filter(order => {
                        const deliveryDate = new Date(order.deliveryDate);
                        const today = new Date();
                        const daysDiff = (deliveryDate - today) / (1000 * 60 * 60 * 24);
                        return daysDiff <= 7 && order.status !== 'completed';
                    });
                    filteredData = urgentOrders;
                    searchResults.filters.push('ç·Šæ€¥æ¡ˆä»¶');
                }

                // çµ±è¨ˆæƒ…å ±ã®ç”Ÿæˆ
                if (normalizedQuery.includes('é‡é‡') || normalizedQuery.includes('ç·é‡é‡')) {
                    const totalWeight = filteredData.reduce((sum, order) => sum + order.totalWeight, 0);
                    searchResults.summary = `ç·é‡é‡: ${totalWeight.toFixed(1)}kg`;
                }

                searchResults.data = filteredData;

                // æ¤œç´¢çµæœã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«åæ˜ ï¼ˆé–¢æ•°ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
                if (typeof updateTable === 'function' && filteredData.length !== orders.length) {
                    filteredOrders = filteredData;
                    updateTable();
                }

                return searchResults;

            } catch (error) {
                console.error('è‡ªç„¶è¨€èªå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                return { data: orders, summary: 'ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', filters: [] };
            }
        }

        // ãƒ¡ã‚¤ãƒ³AI APIå‘¼ã³å‡ºã—é–¢æ•°
        async function callAIAPI(message, context) {
            return generateLocalResponse(message, context);
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†ã§ã®å›ç­”ç”Ÿæˆ
        function generateLocalResponse(message, context) {
            const { data, summary, filters } = context;
            const normalizedQuery = message.toLowerCase();

            if (filters.length > 0) {
                let response = `${filters.join('ã€')}ã®æ¤œç´¢çµæœã‚’ãŠè¦‹ã›ã—ã¦ã„ã¾ã™ã€‚\n\n`;
                
                if (data.length === 0) {
                    response += 'è©²å½“ã™ã‚‹æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
                } else {
                    response += `${data.length}ä»¶ã®æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚\n`;
                    
                    if (summary) {
                        response += summary + '\n';
                    }
                    
                    // ãƒˆãƒƒãƒ—3ã®æ³¨æ–‡ã‚’è¡¨ç¤º
                    const topOrders = data.slice(0, 3);
                    response += '\nä¸»ãªæ³¨æ–‡:\n';
                    topOrders.forEach((order, index) => {
                        response += `${index + 1}. ${order.productName} (${order.material}) - ${order.totalWeight}kg\n`;
                    });
                    
                    if (data.length > 3) {
                        response += `\nä»– ${data.length - 3}ä»¶ã®æ³¨æ–‡ãŒã‚ã‚Šã¾ã™ã€‚`;
                    }
                }
                
                return response;
            } else if (normalizedQuery.includes('ã“ã‚“ã«ã¡ã¯') || normalizedQuery.includes('ã¯ã˜ã‚ã¾ã—ã¦')) {
                return 'ã“ã‚“ã«ã¡ã¯ï¼ã‚¹ãƒ†ãƒ³ãƒ¬ã‚¹é‹³é€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚\n\nä»¥ä¸‹ã®ã‚ˆã†ãªè³ªå•ã«ãŠç­”ãˆã§ãã¾ã™ï¼š\nâ€¢ "S14æã‚’è¡¨ç¤º" - ç‰¹å®šæè³ªã®æ¤œç´¢\nâ€¢ "ç·Šæ€¥ã®æ³¨æ–‡ã¯ï¼Ÿ" - ç·Šæ€¥æ¡ˆä»¶ã®ç¢ºèª\nâ€¢ "ç·é‡é‡ã‚’æ•™ãˆã¦" - çµ±è¨ˆæƒ…å ±ã®è¡¨ç¤º\n\nãŠæ°—è»½ã«ãŠèããã ã•ã„ï¼';
            } else if (normalizedQuery.includes('ã‚ã‚ŠãŒã¨ã†')) {
                return 'ã©ã†ã„ãŸã—ã¾ã—ã¦ï¼ä»–ã«ã‚‚ã”è³ªå•ãŒã‚ã‚Œã°ãŠæ°—è»½ã«ãŠèããã ã•ã„ã€‚';
            } else {
                return `ã€Œ${message}ã€ã«ã¤ã„ã¦ãŠç­”ãˆã—ã¾ã™ã€‚\n\nç¾åœ¨ ${orders.length}ä»¶ã®æ³¨æ–‡ã‚’ç®¡ç†ä¸­ã§ã™ã€‚å…·ä½“çš„ãªæ¤œç´¢ã‚’è¡Œã†å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãŠèããã ã•ã„ï¼š\nâ€¢ æè³ªæŒ‡å®š: "S14æã‚’è¡¨ç¤º"\nâ€¢ ç·Šæ€¥åº¦: "ç·Šæ€¥ã®æ³¨æ–‡ã¯ï¼Ÿ"\nâ€¢ çµ±è¨ˆæƒ…å ±: "ç·é‡é‡ã‚’æ•™ãˆã¦"`;
            }
        }

        // === PDFæ©Ÿèƒ½ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼‰ ===
        let currentPDF = null;
        let currentPage = 1;

        // PDFãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showPDFModal() {
            resetPDFModal();
            const modal = new bootstrap.Modal(document.getElementById('pdfModal'));
            modal.show();
        }

        // PDFãƒ¢ãƒ¼ãƒ€ãƒ«ãƒªã‚»ãƒƒãƒˆ
        function resetPDFModal() {
            const pdfFileInput = document.getElementById('pdfFileInput');
            const pdfProcessingStatus = document.getElementById('pdfProcessingStatus');
            const pdfPreview = document.getElementById('pdfPreview');
            const extractedDataContainer = document.getElementById('extractedDataContainer');
            const noDataMessage = document.getElementById('noDataMessage');
            const extractedText = document.getElementById('extractedText');
            const addFromPDFBtn = document.getElementById('addFromPDFBtn');
            const pdfExtractedForm = document.getElementById('pdfExtractedForm');

            if (pdfFileInput) pdfFileInput.value = '';
            if (pdfProcessingStatus) pdfProcessingStatus.classList.add('d-none');
            if (pdfPreview) pdfPreview.classList.add('d-none');
            if (extractedDataContainer) extractedDataContainer.classList.add('d-none');
            if (noDataMessage) noDataMessage.classList.remove('d-none');
            if (extractedText) extractedText.value = '';
            if (addFromPDFBtn) addFromPDFBtn.disabled = true;
            if (pdfExtractedForm) pdfExtractedForm.reset();

            currentPDF = null;
            currentPage = 1;
        }

        // PDFãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
        async function handlePDFFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'application/pdf') {
                alert('PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                // å‡¦ç†ä¸­è¡¨ç¤º
                const pdfProcessingStatus = document.getElementById('pdfProcessingStatus');
                const noDataMessage = document.getElementById('noDataMessage');
                
                if (pdfProcessingStatus) pdfProcessingStatus.classList.remove('d-none');
                if (noDataMessage) noDataMessage.classList.add('d-none');

                // PDF.jsã®ç¢ºèªã¨è¨­å®š
                if (typeof pdfjsLib === 'undefined') {
                    throw new Error('PDF.jsãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                // PDF.js Workerè¨­å®šï¼ˆè­¦å‘Šè§£æ¶ˆï¼‰
                if (!pdfjsLib.GlobalWorkerOptions.workerSrc) {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                }

                // PDFã‚’èª­ã¿è¾¼ã¿
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                currentPDF = pdf;

                // æœ€åˆã®ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
                await renderPDFPage(1);

                // ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºï¼ˆãƒšãƒ¼ã‚¸åˆ¥ï¼‰
                const pagesData = await extractTextFromPDF(pdf);
                
                // å„ãƒšãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
                for (let pageData of pagesData) {
                    pageData.extractedData = extractDataFromText(pageData.text);
                    console.log(`ãƒšãƒ¼ã‚¸${pageData.pageNumber}ã®æŠ½å‡ºçµæœ:`, pageData.extractedData);
                }

                // è¤‡æ•°ãƒšãƒ¼ã‚¸è¡¨ç¤ºã®ç”Ÿæˆ
                displayMultiPageResults(pagesData);

                // UIæ›´æ–°
                if (pdfProcessingStatus) pdfProcessingStatus.classList.add('d-none');
                const pdfPreview = document.getElementById('pdfPreview');
                const extractedDataContainer = document.getElementById('extractedDataContainer');
                
                if (pdfPreview) pdfPreview.classList.remove('d-none');
                if (extractedDataContainer) extractedDataContainer.classList.remove('d-none');
                if (noDataMessage) noDataMessage.classList.add('d-none');

                // ãƒ•ã‚©ãƒ¼ãƒ ç›£è¦–æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
                setupFormWatchers();

            } catch (error) {
                console.error('PDFå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                alert('PDFã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š' + error.message);
                const pdfProcessingStatus = document.getElementById('pdfProcessingStatus');
                if (pdfProcessingStatus) pdfProcessingStatus.classList.add('d-none');
            }
        }

        // PDFãƒšãƒ¼ã‚¸ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        async function renderPDFPage(pageNumber) {
            if (!currentPDF) return;

            try {
                const page = await currentPDF.getPage(pageNumber);
                const canvas = document.getElementById('pdfCanvas');
                if (!canvas) return;
                
                const context = canvas.getContext('2d');
                const containerWidth = canvas.parentElement.clientWidth - 40;
                const viewport = page.getViewport({ scale: 1 });
                const scale = containerWidth / viewport.width;
                const scaledViewport = page.getViewport({ scale: scale });

                canvas.width = scaledViewport.width;
                canvas.height = scaledViewport.height;

                await page.render({
                    canvasContext: context,
                    viewport: scaledViewport
                }).promise;

                const pdfPageInfo = document.getElementById('pdfPageInfo');
                if (pdfPageInfo) {
                    pdfPageInfo.textContent = `${pageNumber} / ${currentPDF.numPages}`;
                }

            } catch (error) {
                console.error('ãƒšãƒ¼ã‚¸ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // PDFãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºï¼ˆãƒšãƒ¼ã‚¸åˆ¥å¯¾å¿œï¼‰
        async function extractTextFromPDF(pdf) {
            const pagesData = [];

            for (let i = 1; i <= pdf.numPages; i++) {
                try {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    
                    // ãƒšãƒ¼ã‚¸ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´
                    pagesData.push({
                        pageNumber: i,
                        text: pageText,
                        extractedData: null // å¾Œã§æŠ½å‡ºãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´
                    });
                    
                    console.log(`ãƒšãƒ¼ã‚¸${i}ã®ãƒ†ã‚­ã‚¹ãƒˆé•·:`, pageText.length);
                } catch (error) {
                    console.error(`ãƒšãƒ¼ã‚¸ ${i} ã®ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã‚¨ãƒ©ãƒ¼:`, error);
                }
            }

            return pagesData;
        }

        // æ”¹å–„ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿æŠ½å‡ºæ©Ÿèƒ½
        function extractDataFromText(text) {
            const data = {
                orderNumber: '',
                customer: '',
                productCode: '',
                productName: '',
                material: '',
                unitWeight: '',
                quantity: '',
                orderDate: '',      // ç™ºæ³¨æ—¥ã‚’è¿½åŠ 
                deliveryDate: '',
                notes: ''
            };

            try {
                console.log('=== PDFè§£æé–‹å§‹ ===');
                console.log('æŠ½å‡ºãƒ†ã‚­ã‚¹ãƒˆï¼ˆå…¨ä½“ï¼‰:', text.substring(0, 1000) + '...');
                console.log('ãƒ†ã‚­ã‚¹ãƒˆé•·:', text.length);
                
                // è¡Œåˆ¥ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
                const lines = text.split('\n');
                console.log('è¡Œæ•°:', lines.length);
                lines.forEach((line, index) => {
                    if (line.trim() && index < 20) { // æœ€åˆã®20è¡Œã®ã¿è¡¨ç¤º
                        console.log(`è¡Œ${index + 1}: "${line}"`);
                    }
                });

                // 1. æ³¨æ–‡ç•ªå·æŠ½å‡º - å—æ³¨ç•ªå·ã€æ³¨æ–‡ç•ªå·ã®æ§˜ã€…ãªãƒ‘ã‚¿ãƒ¼ãƒ³
                const orderPatterns = [
                    /å—æ³¨N[09][:ï¼š]?\s*(\d+)/i,                    // å—æ³¨N9ï¼š12345
                    /å—æ³¨ç•ªå·[:ï¼š]\s*([A-Z0-9\-]+)/i,              // å—æ³¨ç•ªå·ï¼šABC123
                    /æ³¨æ–‡ç•ª?å·[:ï¼š\s]*([A-Z0-9\-]+)/i,             // æ³¨æ–‡ç•ªå·ï¼š123-456
                    /Order\s*No\.?\s*[:ï¼š]?\s*([A-Z0-9\-]+)/i,    // Order No: ORD123
                    /ç™ºæ³¨ç•ª?å·[:ï¼š\s]*([A-Z0-9\-\s]+)/i,           // ç™ºæ³¨ç•ªå·ï¼š39 83 81 (ã‚¹ãƒšãƒ¼ã‚¹å«ã‚€)
                    /ç™ºæ³¨â„–[:ï¼š\s]*([A-Z0-9\-\s]+)/i,               // ç™ºæ³¨â„–ï¼š39 83 81
                    /NO\.?\s*[:ï¼š]?\s*([A-Z0-9\-]+)/i,            // NO: 123456
                    /ç®¡ç†ç•ªå·[:ï¼š\s]*([A-Z0-9\-]+)/i,              // ç®¡ç†ç•ªå·ï¼šMGT123
                    /([0-9]{8})/g,                                // 8æ¡ã®æ•°å­— (00000142)
                    /([0-9]{2}\s+[0-9]{2}\s+[0-9]{2})/g,         // ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã®ç•ªå· (39 83 81)
                    /(\d{8})/g,                                   // 8æ¡é€£ç¶šæ•°å­—ã®æ”¹è‰¯ç‰ˆ
                    /([0-9]+\s+[0-9]+\s+[0-9]+)/g,               // è¤‡æ•°æ¡ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šç•ªå·
                    /^[\s]*([0-9]{8,})[\s]*$/m,                  // è¡Œé ­ã‹ã‚‰8æ¡ä»¥ä¸Šã®æ•°å­—
                    /ç™ºæ³¨\s*â„–?\s*[:ï¼š]?\s*([A-Z0-9\-\s]+?)[\s\n]/i, // ç™ºæ³¨â„–ã®æ”¹è‰¯ç‰ˆ
                    /å—æ³¨\s*N[Oo0]?\s*[:ï¼š]?\s*([A-Z0-9\-\s]+?)[\s\n]/i // å—æ³¨No ã®æ”¹è‰¯ç‰ˆ
                ];
                
                for (let i = 0; i < orderPatterns.length; i++) {
                    const pattern = orderPatterns[i];
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        data.orderNumber = match[1].trim();
                        console.log(`æ³¨æ–‡ç•ªå·æŠ½å‡ºï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³${i+1}ï¼‰:`, data.orderNumber, 'ãƒãƒƒãƒ:', match[0]);
                        break;
                    } else if (i < 5) { // æœ€åˆã®5ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
                        console.log(`æ³¨æ–‡ç•ªå·ãƒ‘ã‚¿ãƒ¼ãƒ³${i+1}ãƒãƒƒãƒãªã—:`, pattern);
                    }
                }

                // 2. ç™ºæ³¨è€…æŠ½å‡º - æ³¨æ–‡è€…ã€ç™ºæ³¨è€…ã€ä¼šç¤¾å
                const customerPatterns = [
                    /æ³¨æ–‡è€…[:ï¼š\s]*([^\n\r\s]+(?:\s+[^\n\r\s]+)*)/i,      // æ³¨æ–‡è€…ï¼šä¼šç¤¾å
                    /ç™ºæ³¨è€…[:ï¼š\s]*([^\n\r\s]+(?:\s+[^\n\r\s]+)*)/i,      // ç™ºæ³¨è€…ï¼šä¼šç¤¾å
                    /ä¼šç¤¾å[:ï¼š\s]*([^\n\r\s]+(?:\s+[^\n\r\s]+)*)/i,      // ä¼šç¤¾åï¼šä¼šç¤¾å
                    /å¾¡ç™ºæ³¨[:ï¼š\s]*([^\n\r\s]+(?:\s+[^\n\r\s]+)*)/i,      // å¾¡ç™ºæ³¨ï¼šä¼šç¤¾å
                    /(æ ªå¼ä¼šç¤¾[^\s\n\r]+)/i,                             // æ ªå¼ä¼šç¤¾XXX
                    /(æœ‰é™ä¼šç¤¾[^\s\n\r]+)/i,                             // æœ‰é™ä¼šç¤¾XXX
                    /([^\s\n\r]*å·¥æ¥­[^\s\n\r]*)/i,                       // XXXå·¥æ¥­
                    /([^\s\n\r]*è£½ä½œæ‰€[^\s\n\r]*)/i                      // XXXè£½ä½œæ‰€
                ];
                
                for (const pattern of customerPatterns) {
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        data.customer = match[1].trim();
                        console.log('ç™ºæ³¨è€…æŠ½å‡º:', data.customer);
                        break;
                    }
                }

                // 3. å“ç•ªæŠ½å‡º - è‹±æ•°å­—ã®çµ„ã¿åˆã‚ã›ï¼ˆä¾‹ï¼š7-B7912-ï½¼ï¼‰
                const productCodePatterns = [
                    /å“ç•ª[:ï¼š\s]*([A-Z0-9\-ï½¼]+)/i,                       // å“ç•ªï¼š7-B7912-2
                    /å‹ç•ª[:ï¼š\s]*([A-Z0-9\-ï½¼]+)/i,                       // å‹ç•ªï¼šABC-123
                    /Part\s*No\.?\s*[:ï¼š]?\s*([A-Z0-9\-ï½¼]+)/i,          // Part No: 123-456
                    /è£½å“ç•ªå·[:ï¼š\s]*([A-Z0-9\-ï½¼]+)/i,                   // è£½å“ç•ªå·ï¼šPRD123
                    /å“ç›®\s*\(\s*([0-9]+\-[A-Z]+[0-9]+[\-ï½¼]*[0-9]*)\s*\)/i, // å“ç›® (7-B7912-ï½¼) å½¢å¼
                    /([0-9]+\-[A-Z]+[0-9]+[\-ï½¼]*[0-9]*)/g,              // 7-B7912-2 ã¾ãŸã¯ 7-B7912-ï½¼ å½¢å¼
                    /([A-Z]+[0-9]+\-[0-9]+\-[0-9]+)/g,                   // ABC123-45-6 å½¢å¼
                    /([A-Z]+\-[0-9]+\-[A-Z0-9]+)/g,                      // ABC-123-XYZ å½¢å¼
                    /(P[0-9]+\-[0-9]+\-[0-9]+)/g,                        // P815-110-0162 å½¢å¼
                    /(7\-B7\s*9\s*12[\-ï½¼]*)/g,                          // ã‚¹ãƒšãƒ¼ã‚¹å…¥ã‚Šãƒ‘ã‚¿ãƒ¼ãƒ³ 7-B7 9 12-ï½¼
                    /([0-9]+[\-\s]*[A-Z]+[0-9]+[\-\s]*ï½¼)/i,             // 7-B7912-ï½¼ ã®ã‚ˆã†ãªç‰¹æ®Šæ–‡å­—å«ã‚€
                    /^[\s]*([0-9]+\-[A-Z]+[0-9]+[\-ï½¼]+[0-9]*)[\s]*$/m   // è¡Œç‹¬ç«‹ã®å“ç•ªãƒ‘ã‚¿ãƒ¼ãƒ³
                ];
                
                for (let i = 0; i < productCodePatterns.length; i++) {
                    const pattern = productCodePatterns[i];
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        data.productCode = match[1].trim();
                        console.log(`å“ç•ªæŠ½å‡ºï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³${i+1}ï¼‰:`, data.productCode, 'ãƒãƒƒãƒ:', match[0]);
                        break;
                    } else if (i < 5) { // æœ€åˆã®5ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
                        console.log(`å“ç•ªãƒ‘ã‚¿ãƒ¼ãƒ³${i+1}ãƒãƒƒãƒãªã—:`, pattern);
                    }
                }

                // 4. å“åæŠ½å‡º - å“ç•ªã®è¿‘ãã«ã‚ã‚‹æ—¥æœ¬èªåç§°
                const productNamePatterns = [
                    /å“å[:ï¼š\s]*([^\n\r]+)/i,                           // å“åï¼šã‚³ãƒã‚¯ã‚¿ VLN-15
                    /è£½å“å[:ï¼š\s]*([^\n\r]+)/i,                         // è£½å“åï¼šãƒ•ãƒ©ãƒ³ã‚¸
                    /éƒ¨å“å[:ï¼š\s]*([^\n\r]+)/i,                         // éƒ¨å“åï¼šãƒœãƒ«ãƒˆ
                    /åç§°[:ï¼š\s]*([^\n\r]+)/i,                           // åç§°ï¼šã‚¬ã‚¹ã‚±ãƒƒãƒˆ
                    /å“ç›®[^(]*\([^)]*\)\s*\*?\s*([ï½±-ï¾ï½¼ï¾˜ï¾ï¾€ï¾][^ã€\n\r]*)/i, // å“ç›® (7-B7912-ï½¼) * ï½¼ï¾˜ï¾ï¾€ï¾(ï¾ï½²ï½¶ï¾ï¾œ)
                    /(ï½¼ï¾˜ï¾ï¾€ï¾[^ã€\n\r]*\([^)]*\))/i,                      // ï½¼ï¾˜ï¾ï¾€ï¾(ï¾ï½²ï½¶ï¾ï¾œ) æ”¹è‰¯ç‰ˆ
                    /(ï½¼ï¾˜ï¾ï¾€ï¾[^ã€\n\r]*)/i,                              // ï½¼ï¾˜ï¾ï¾€ï¾XXX
                    /(ã‚³ãƒã‚¯ã‚¿[^\n\r]*)/i,                               // ã‚³ãƒã‚¯ã‚¿ XXX
                    /(ãƒ•ãƒ©ãƒ³ã‚¸[^\n\r]*)/i,                               // ãƒ•ãƒ©ãƒ³ã‚¸ XXX
                    /(ãƒœãƒ«ãƒˆ[^\n\r]*)/i,                                 // ãƒœãƒ«ãƒˆ XXX
                    /(ãƒŠãƒƒãƒˆ[^\n\r]*)/i,                                 // ãƒŠãƒƒãƒˆ XXX
                    /(ã‚¬ã‚¹ã‚±ãƒƒãƒˆ[^\n\r]*)/i,                             // ã‚¬ã‚¹ã‚±ãƒƒãƒˆ XXX
                    /(ç¶™æ‰‹[^\n\r]*)/i,                                   // ç¶™æ‰‹ XXX
                    /(ãƒãƒ«ãƒ–[^\n\r]*)/i,                                 // ãƒãƒ«ãƒ– XXX
                    /(ã‚·ãƒªãƒ³ãƒ€[^\n\r]*)/i,                               // ã‚·ãƒªãƒ³ãƒ€ XXX
                    /\*\s*([ï½±-ï¾][ï½±-ï¾\(\)]+)/i,                        // * ï½¼ï¾˜ï¾ï¾€ï¾(ï¾ï½²ï½¶ï¾ï¾œ) ã®ã‚ˆã†ãªå ´åˆ
                    /([ï½±-ï¾]+\([ï½±-ï¾]+\))/i                              // ã‚«ã‚¿ã‚«ãƒŠå(ã‚«ã‚¿ã‚«ãƒŠ) ãƒ‘ã‚¿ãƒ¼ãƒ³
                ];
                
                for (let i = 0; i < productNamePatterns.length; i++) {
                    const pattern = productNamePatterns[i];
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        data.productName = match[1].trim();
                        console.log(`å“åæŠ½å‡ºï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³${i+1}ï¼‰:`, data.productName, 'ãƒãƒƒãƒ:', match[0]);
                        break;
                    } else if (i < 5) { // æœ€åˆã®5ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
                        console.log(`å“åãƒ‘ã‚¿ãƒ¼ãƒ³${i+1}ãƒãƒƒãƒãªã—:`, pattern);
                    }
                }

                // 5. æè³ªæŠ½å‡º - S13, S14, SCM435, SUS304, FCD400ç­‰
                const materials = [
                    'S13', 'S14', 'S15', 'SCM435', 'SCM440', 'SUS304', 'SUS316', 'SUS430',
                    'SCS13', 'SCS14', 'SCS16', 'SCS1', 'SCS2', 'SCS3', 'SCS5', 'SCS6',
                    'FC200', 'FC250', 'FC300', 'FC350', 'FC400', 'FCD400', 'FCD450', 'FCD500', 'FCD600', 'FCD700',
                    'SCPH1', 'SCPH2', 'SCPH11', 'SCPH12', 'SCPH13', 'SCPH21', 'SCPH32',
                    'SS400', 'SM490', 'A5052', 'A6061', 'A7075', 'C3604', 'C3771'
                ];
                
                // æè³ªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å„ªå…ˆé †ã§æ¤œç´¢ï¼ˆFCDã€FCã€SCPHæ‹¡å¼µã€ã‚¹ãƒšãƒ¼ã‚¹å¯¾å¿œï¼‰
                const materialPatterns = [
                    /æè³ª[:ï¼š\s]*(S13|S14|S15|SCM[0-9]+|SUS[0-9]+|SCS[0-9]+|FCD[0-9]+[\-0-9]*|FC[0-9]+|SCPH[0-9]+)/i,
                    /ææ–™[:ï¼š\s]*(S13|S14|S15|SCM[0-9]+|SUS[0-9]+|SCS[0-9]+|FCD[0-9]+[\-0-9]*|FC[0-9]+|SCPH[0-9]+)/i,
                    /ã€\s*([FC]\s*[CD]*\s*[0-9]+\s*[\-0-9]*)\s*ã€‘/i,     // ã€F   C   D400-15   ã€‘å½¢å¼ï¼ˆã‚¹ãƒšãƒ¼ã‚¹å…¥ã‚Šï¼‰
                    /ã€\s*(FCD\s*[0-9]+\s*[\-0-9]*)\s*ã€‘/i,              // ã€FCD450-10ã€‘å½¢å¼
                    /ã€\s*(FC\s*[0-9]+\s*[\-0-9]*)\s*ã€‘/i,               // ã€FC250ã€‘å½¢å¼
                    /ã€\s*(SCPH\s*[0-9]+\s*[\-0-9]*)\s*ã€‘/i,             // ã€SCPH2ã€‘å½¢å¼
                    /(FCD\s*[0-9]+\s*[\-0-9]*)/i,                        // FCD450-10 ç›´æ¥ãƒãƒƒãƒï¼ˆã‚¹ãƒšãƒ¼ã‚¹å…¥ã‚Šï¼‰
                    /(FC\s*[0-9]+\s*[\-0-9]*)/i,                         // FC250 ç›´æ¥ãƒãƒƒãƒï¼ˆã‚¹ãƒšãƒ¼ã‚¹å…¥ã‚Šï¼‰
                    /(SCPH\s*[0-9]+\s*[\-0-9]*)/i,                       // SCPH2 ç›´æ¥ãƒãƒƒãƒï¼ˆã‚¹ãƒšãƒ¼ã‚¹å…¥ã‚Šï¼‰
                    /\[\s*(FCD\s*[0-9]+\s*[\-0-9]*)\s*\]/i,              // [FCD450-10]å½¢å¼
                    /\[\s*(FC\s*[0-9]+\s*[\-0-9]*)\s*\]/i,               // [FC250]å½¢å¼
                    /\[\s*(SCPH\s*[0-9]+\s*[\-0-9]*)\s*\]/i,             // [SCPH2]å½¢å¼
                    /^[\s]*ã€\s*(FCD\s*[0-9]+\s*[\-0-9]*)\s*ã€‘[\s]*$/m,  // è¡Œç‹¬ç«‹ã®ã€FCDæè³ªã€‘ãƒ‘ã‚¿ãƒ¼ãƒ³
                    /^[\s]*ã€\s*(FC\s*[0-9]+\s*[\-0-9]*)\s*ã€‘[\s]*$/m,   // è¡Œç‹¬ç«‹ã®ã€FCæè³ªã€‘ãƒ‘ã‚¿ãƒ¼ãƒ³
                    /^[\s]*ã€\s*(SCPH\s*[0-9]+\s*[\-0-9]*)\s*ã€‘[\s]*$/m, // è¡Œç‹¬ç«‹ã®ã€SCPHæè³ªã€‘ãƒ‘ã‚¿ãƒ¼ãƒ³
                    /\s+(FCD\s*[0-9]+\s*[\-0-9]*)\s+/i,                  // ã‚¹ãƒšãƒ¼ã‚¹ã«å›²ã¾ã‚ŒãŸFCDæè³ª
                    /\s+(FC\s*[0-9]+\s*[\-0-9]*)\s+/i,                   // ã‚¹ãƒšãƒ¼ã‚¹ã«å›²ã¾ã‚ŒãŸFCæè³ª
                    /\s+(SCPH\s*[0-9]+\s*[\-0-9]*)\s+/i,                 // ã‚¹ãƒšãƒ¼ã‚¹ã«å›²ã¾ã‚ŒãŸSCPHæè³ª
                    /è³ª\s*[\(ï¼ˆ]\s*(FCD\s*[0-9]+\s*[\-0-9]*)\s*[\)ï¼‰]/i, // è³ª(FCD450-10)ãƒ‘ã‚¿ãƒ¼ãƒ³
                    /è³ª\s*[\(ï¼ˆ]\s*(FC\s*[0-9]+\s*[\-0-9]*)\s*[\)ï¼‰]/i,  // è³ª(FC250)ãƒ‘ã‚¿ãƒ¼ãƒ³
                    /è³ª\s*[\(ï¼ˆ]\s*(SCPH\s*[0-9]+\s*[\-0-9]*)\s*[\)ï¼‰]/i, // è³ª(SCPH2)ãƒ‘ã‚¿ãƒ¼ãƒ³
                    /^[\s]*(FCD\s*[0-9]+\s*[\-0-9]*)[\s]*$/m,            // è¡Œç‹¬ç«‹ã®FCDæè³ª
                    /^[\s]*(FC\s*[0-9]+\s*[\-0-9]*)[\s]*$/m,             // è¡Œç‹¬ç«‹ã®FCæè³ª
                    /^[\s]*(SCPH\s*[0-9]+\s*[\-0-9]*)[\s]*$/m            // è¡Œç‹¬ç«‹ã®SCPHæè³ª
                ];
                
                for (let i = 0; i < materialPatterns.length; i++) {
                    const pattern = materialPatterns[i];
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        // ã‚¹ãƒšãƒ¼ã‚¹ã‚’é™¤å»ã—ã¦æ­£è¦åŒ–
                        data.material = match[1].replace(/\s+/g, '').toUpperCase();
                        console.log(`æè³ªæŠ½å‡ºï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³${i+1}ï¼‰:`, data.material, 'ãƒãƒƒãƒ:', match[0]);
                        break;
                    } else if (i < 5) { // æœ€åˆã®5ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
                        console.log(`æè³ªãƒ‘ã‚¿ãƒ¼ãƒ³${i+1}ãƒãƒƒãƒãªã—:`, pattern);
                    }
                }
                
                // ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã§è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å˜èªæ¤œç´¢
                if (!data.material) {
                    for (const material of materials) {
                        if (text.toUpperCase().includes(material)) {
                            data.material = material;
                            console.log('æè³ªæŠ½å‡ºï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼‰:', data.material);
                            break;
                        }
                    }
                }

                // 6. é‡é‡æŠ½å‡º - "é‡é‡" "kg" ã®å‰ã®æ•°å€¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                const weightPatterns = [
                    /é‡é‡[:ï¼š\s]*([0-9]+\.?[0-9]*)\s*kg/i,                // é‡é‡ï¼š13.2kg
                    /å˜é‡[:ï¼š\s]*([0-9]+\.?[0-9]*)\s*kg/i,                // å˜é‡ï¼š13.2kg
                    /é‡ã•[:ï¼š\s]*([0-9]+\.?[0-9]*)\s*kg/i,                // é‡ã•ï¼š13.2kg
                    /([0-9]+\.?[0-9]*)\s*kg/gi,                          // 13.2kg
                    /([0-9]+\.?[0-9]*)\s*ã/gi,                          // 29.5ã
                    /é‡é‡[:ï¼š\s]*([0-9]+\.?[0-9]*)/i,                     // é‡é‡ï¼š13.2ï¼ˆå˜ä½ãªã—ï¼‰
                    /å˜é‡[:ï¼š\s]*([0-9]+\.?[0-9]*)/i,                     // å˜é‡ï¼š13.2ï¼ˆå˜ä½ãªã—ï¼‰
                    /([0-9]+)\s*\.\s*([0-9]+)\s*ã/i,                     // 2 9 .5ã (ã‚¹ãƒšãƒ¼ã‚¹å…¥ã‚Š)
                    /([0-9]+\s*[0-9]*)\s*\.\s*([0-9]+)\s*ã/i,            // 29 .5ã ã®ã‚ˆã†ãªåˆ†é›¢ãƒ‘ã‚¿ãƒ¼ãƒ³
                    /([0-9]{1,2})\s*\.\s*([0-9]+)\s*kg/gi,               // 29 .5kg ã®åˆ†é›¢ãƒ‘ã‚¿ãƒ¼ãƒ³
                    /é‡é‡\s*[:ï¼š]?\s*([0-9]+[\.\s]*[0-9]*)\s*[kgcgã]/i  // é‡é‡åˆ†é›¢ãƒ‘ã‚¿ãƒ¼ãƒ³
                ];
                
                for (const pattern of weightPatterns) {
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        // ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã®é‡é‡ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å ´åˆ
                        if (match[2]) {
                            data.unitWeight = parseFloat(match[1] + '.' + match[2]);
                        } else {
                            data.unitWeight = parseFloat(match[1]);
                        }
                        console.log('é‡é‡æŠ½å‡º:', data.unitWeight);
                        break;
                    }
                }

                // 7. æ•°é‡æŠ½å‡º - "æ•°é‡" "å€‹" "ã‚±" ã®å‰ã®æ•°å€¤
                const quantityPatterns = [
                    /æ•°é‡[:ï¼š\s]*([0-9]+)/i,                             // æ•°é‡ï¼š2
                    /å€‹æ•°[:ï¼š\s]*([0-9]+)/i,                             // å€‹æ•°ï¼š2
                    /qty[:ï¼š\s]*([0-9]+)/i,                              // qtyï¼š2
                    /([0-9]+)\s*å€‹/gi,                                   // 2å€‹
                    /([0-9]+)\s*ã‚±/gi,                                   // 2ã‚±
                    /([0-9]+)\s*ãƒ¶/gi,                                   // 2ãƒ¶
                    /([0-9]+)\s*pc/gi,                                   // 2pc
                    /([0-9]+)\s*pcs/gi                                   // 2pcs
                ];
                
                for (const pattern of quantityPatterns) {
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        data.quantity = parseInt(match[1]);
                        console.log('æ•°é‡æŠ½å‡º:', data.quantity);
                        break;
                    }
                }

                // 8. ç™ºæ³¨æ—¥æŠ½å‡º - ç™ºæ³¨æ—¥ã€æ³¨æ–‡æ—¥ã®æ—¥ä»˜å½¢å¼ï¼ˆã‚¹ãƒšãƒ¼ã‚¹å¯¾å¿œï¼‰
                const orderDatePatterns = [
                    /ç™ºæ³¨æ—¥[:ï¼š\s]*([0-9]{4})[.\-\/å¹´\s]*([0-9]{1,2})[.\-\/æœˆ\s]*([0-9]{1,2})/i,  // ç™ºæ³¨æ—¥ï¼š2025.07.01
                    /æ³¨æ–‡æ—¥[:ï¼š\s]*([0-9]{4})[.\-\/å¹´\s]*([0-9]{1,2})[.\-\/æœˆ\s]*([0-9]{1,2})/i,  // æ³¨æ–‡æ—¥ï¼š2025.07.01
                    /å—æ³¨æ—¥[:ï¼š\s]*([0-9]{4})[.\-\/å¹´\s]*([0-9]{1,2})[.\-\/æœˆ\s]*([0-9]{1,2})/i,  // å—æ³¨æ—¥ï¼š2025.07.01
                    /æ—¥ä»˜[:ï¼š\s]*([0-9]{4})[.\-\/å¹´\s]*([0-9]{1,2})[.\-\/æœˆ\s]*([0-9]{1,2})/i,    // æ—¥ä»˜ï¼š2025.07.01
                    /ä½œæˆæ—¥[:ï¼š\s]*([0-9]{4})[.\-\/å¹´\s]*([0-9]{1,2})[.\-\/æœˆ\s]*([0-9]{1,2})/i,  // ä½œæˆæ—¥ï¼š2025.07.01
                    /([0-9]{4})[\.\s]*([0-9]{1,2})[\.\s]*([0-9]{1,2})/g,                         // 2025.0 7. 01 å½¢å¼ï¼ˆã‚¹ãƒšãƒ¼ã‚¹å…¥ã‚Šï¼‰
                    /([0-9]{4})[.\-\/å¹´]([0-9]{1,2})[.\-\/æœˆ]([0-9]{1,2})/g                     // 2025.07.01å½¢å¼ï¼ˆä¸€èˆ¬ï¼‰
                ];
                
                for (let i = 0; i < orderDatePatterns.length; i++) {
                    const pattern = orderDatePatterns[i];
                    const match = text.match(pattern);
                    if (match && match[1] && match[2] && match[3]) {
                        // ã‚¹ãƒšãƒ¼ã‚¹ã‚’é™¤å»ã—ã¦æ•°å€¤ã«å¤‰æ›
                        const year = match[1].replace(/\s+/g, '');
                        const month = match[2].replace(/\s+/g, '').padStart(2, '0');
                        const day = match[3].replace(/\s+/g, '').padStart(2, '0');
                        const dateStr = `${year}-${month}-${day}`;
                        const date = new Date(dateStr);
                        
                        if (!isNaN(date.getTime()) && date.getFullYear() >= 2020 && date.getFullYear() <= 2030) {
                            data.orderDate = dateStr;
                            console.log(`ç™ºæ³¨æ—¥æŠ½å‡ºï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³${i+1}ï¼‰:`, data.orderDate, 'ãƒãƒƒãƒ:', match[0]);
                            break;
                        }
                    } else if (i < 3) { // æœ€åˆã®3ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
                        console.log(`ç™ºæ³¨æ—¥ãƒ‘ã‚¿ãƒ¼ãƒ³${i+1}ãƒãƒƒãƒãªã—:`, pattern);
                    }
                }

                // 9. ç´æœŸæŠ½å‡º - æ—¥ä»˜å½¢å¼ï¼ˆ2025.06.05 â†’ 2025/06/05ï¼‰
                const deliveryDatePatterns = [
                    /ç´æœŸ[:ï¼š\s]*([0-9]{4})[.\-\/å¹´]([0-9]{1,2})[.\-\/æœˆ]([0-9]{1,2})/i,  // ç´æœŸï¼š2025.06.05
                    /ç´å…¥[:ï¼š\s]*([0-9]{4})[.\-\/å¹´]([0-9]{1,2})[.\-\/æœˆ]([0-9]{1,2})/i,  // ç´å…¥ï¼š2025.06.05
                    /ç´å…¥æ—¥[:ï¼š\s]*([0-9]{4})[.\-\/å¹´]([0-9]{1,2})[.\-\/æœˆ]([0-9]{1,2})/i, // ç´å…¥æ—¥ï¼š2025.06.05
                    /å¸Œæœ›ç´æœŸ[:ï¼š\s]*([0-9]{4})[.\-\/å¹´]([0-9]{1,2})[.\-\/æœˆ]([0-9]{1,2})/i, // å¸Œæœ›ç´æœŸï¼š2025.06.05
                    /ç´å…¥å¸Œæœ›æ—¥[:ï¼š\s]*([0-9]{4})[.\-\/å¹´]([0-9]{1,2})[.\-\/æœˆ]([0-9]{1,2})/i, // ç´å…¥å¸Œæœ›æ—¥ï¼š2025.06.05
                    /å®Œæˆå¸Œæœ›[:ï¼š\s]*([0-9]{4})[.\-\/å¹´]([0-9]{1,2})[.\-\/æœˆ]([0-9]{1,2})/i  // å®Œæˆå¸Œæœ›ï¼š2025.06.05
                ];
                
                for (const pattern of deliveryDatePatterns) {
                    const match = text.match(pattern);
                    if (match && match[1] && match[2] && match[3]) {
                        const year = match[1];
                        const month = match[2].padStart(2, '0');
                        const day = match[3].padStart(2, '0');
                        const dateStr = `${year}-${month}-${day}`;
                        const date = new Date(dateStr);
                        
                        if (!isNaN(date.getTime()) && date.getFullYear() >= 2020 && date.getFullYear() <= 2030) {
                            data.deliveryDate = dateStr;
                            console.log('ç´æœŸæŠ½å‡º:', data.deliveryDate);
                            break;
                        }
                    }
                }

                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æŠ½å‡ºï¼ˆç‰¹å®šã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ç‰¹åŒ–ï¼‰
                if (!data.orderNumber || !data.productCode || !data.productName || !data.material || !data.orderDate) {
                    console.log('=== ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æŠ½å‡ºé–‹å§‹ ===');
                    
                    // ã‚ˆã‚Šç©æ¥µçš„ãªæ¤œç´¢
                    if (!data.orderNumber) {
                        // æ•°å­—ã®ã¿ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¢ã™ï¼ˆ8æ¡ã®æ•°å­—ï¼‰
                        const numberMatch = text.match(/\b([0-9]{8})\b/);
                        if (numberMatch) {
                            data.orderNumber = numberMatch[1];
                            console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ³¨æ–‡ç•ªå·:', data.orderNumber);
                        }
                    }
                    
                    if (!data.productCode) {
                        // ã‚ˆã‚Šç·©ã„å“ç•ªãƒ‘ã‚¿ãƒ¼ãƒ³
                        const codeMatch = text.match(/([0-9]+\-[A-Z]+[0-9]+(?:\-?ï½¼)?)/);
                        if (codeMatch) {
                            data.productCode = codeMatch[1];
                            console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å“ç•ª:', data.productCode);
                        }
                    }
                    
                    if (!data.productName) {
                        // ã‚«ã‚¿ã‚«ãƒŠã®ã¿ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
                        const nameMatch = text.match(/(ï½¼ï¾˜ï¾ï¾€ï¾\([^)]+\))/);
                        if (nameMatch) {
                            data.productName = nameMatch[1];
                            console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å“å:', data.productName);
                        }
                    }
                    
                    if (!data.material) {
                        // ã‚¹ãƒšãƒ¼ã‚¹å…¥ã‚ŠFCDã€FCã€SCPHç³»ã®æè³ªã‚’æ¢ã™
                        const matMatch = text.match(/(F\s*C\s*D\s*[0-9]+\s*[\-0-9]*|F\s*C\s*[0-9]+\s*[\-0-9]*|S\s*C\s*P\s*H\s*[0-9]+\s*[\-0-9]*)/i);
                        if (matMatch) {
                            data.material = matMatch[1].replace(/\s+/g, '').toUpperCase();
                            console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æè³ª:', data.material);
                        }
                    }
                    
                    if (!data.orderDate) {
                        // ã‚ˆã‚ŠæŸ”è»Ÿãªç™ºæ³¨æ—¥ãƒ‘ã‚¿ãƒ¼ãƒ³
                        const dateMatch = text.match(/(2025)[\.\s]*([0-9]{1,2})[\.\s]*([0-9]{1,2})/);
                        if (dateMatch) {
                            const year = dateMatch[1];
                            const month = dateMatch[2].replace(/\s+/g, '').padStart(2, '0');
                            const day = dateMatch[3].replace(/\s+/g, '').padStart(2, '0');
                            data.orderDate = `${year}-${month}-${day}`;
                            console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç™ºæ³¨æ—¥:', data.orderDate);
                        }
                    }
                }

                console.log('=== PDFè§£æçµæœ ===');
                console.log('æ³¨æ–‡ç•ªå·:', data.orderNumber);
                console.log('ç™ºæ³¨è€…:', data.customer);
                console.log('å“ç•ª:', data.productCode);
                console.log('å“å:', data.productName);
                console.log('æè³ª:', data.material);
                console.log('é‡é‡:', data.unitWeight);
                console.log('æ•°é‡:', data.quantity);
                console.log('ç™ºæ³¨æ—¥:', data.orderDate);   // ç™ºæ³¨æ—¥ã‚’è¿½åŠ 
                console.log('ç´æœŸ:', data.deliveryDate);

            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã‚¨ãƒ©ãƒ¼:', error);
            }

            return data;
        }

        // è¤‡æ•°ãƒšãƒ¼ã‚¸çµæœè¡¨ç¤ºæ©Ÿèƒ½
        function displayMultiPageResults(pagesData) {
            const extractedDataContainer = document.getElementById('extractedDataContainer');
            if (!extractedDataContainer) return;

            // è¤‡æ•°ãƒšãƒ¼ã‚¸ã®ã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆ
            let tabsHTML = '<ul class="nav nav-tabs" id="pdfPageTabs" role="tablist">';
            let contentHTML = '<div class="tab-content" id="pdfPageTabContent">';

            pagesData.forEach((pageData, index) => {
                const isActive = index === 0 ? 'active' : '';
                const pageNum = pageData.pageNumber;
                
                // ã‚¿ãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼
                tabsHTML += `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ${isActive}" id="page${pageNum}-tab" data-bs-toggle="tab" 
                                data-bs-target="#page${pageNum}" type="button" role="tab" 
                                aria-controls="page${pageNum}" aria-selected="${index === 0}">
                            ãƒšãƒ¼ã‚¸ ${pageNum}
                            ${pageData.extractedData.orderNumber ? 
                                '<span class="badge bg-success ms-1">âœ“</span>' : 
                                '<span class="badge bg-warning ms-1">!</span>'}
                        </button>
                    </li>
                `;

                // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
                contentHTML += `
                    <div class="tab-pane fade ${isActive ? 'show active' : ''}" id="page${pageNum}" 
                         role="tabpanel" aria-labelledby="page${pageNum}-tab">
                        <div class="row mt-3">
                            <div class="col-md-8">
                                ${generatePageDataForm(pageData.extractedData, pageNum)}
                            </div>
                            <div class="col-md-4">
                                ${generatePageSummary(pageData.extractedData, pageNum)}
                            </div>
                        </div>
                    </div>
                `;
            });

            tabsHTML += '</ul>';
            contentHTML += '</div>';

            extractedDataContainer.innerHTML = `
                <div class="mb-3">
                    <h5>ğŸ“„ PDFè§£æçµæœ (${pagesData.length}ãƒšãƒ¼ã‚¸)</h5>
                    <p class="text-muted">å„ãƒšãƒ¼ã‚¸ã®ã‚¿ãƒ–ã‚’é¸æŠã—ã¦å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                </div>
                ${tabsHTML}
                ${contentHTML}
            `;

            // UIè¡¨ç¤º
            extractedDataContainer.classList.remove('d-none');
            const noDataMessage = document.getElementById('noDataMessage');
            if (noDataMessage) noDataMessage.classList.add('d-none');
        }

        // ãƒšãƒ¼ã‚¸åˆ¥ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒ ç”Ÿæˆ
        function generatePageDataForm(data, pageNumber) {
            return `
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">ãƒšãƒ¼ã‚¸ ${pageNumber} - æŠ½å‡ºãƒ‡ãƒ¼ã‚¿</h6>
                    </div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-sm-3"><strong>æ³¨æ–‡ç•ªå·:</strong></div>
                            <div class="col-sm-9">
                                <input type="text" class="form-control form-control-sm ${data.orderNumber ? 'auto-filled' : ''}" 
                                       value="${data.orderNumber}" id="orderNumber_${pageNumber}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-3"><strong>ç™ºæ³¨è€…:</strong></div>
                            <div class="col-sm-9">
                                <input type="text" class="form-control form-control-sm ${data.customer ? 'auto-filled' : ''}" 
                                       value="${data.customer}" id="customer_${pageNumber}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-3"><strong>å“ç•ª:</strong></div>
                            <div class="col-sm-9">
                                <input type="text" class="form-control form-control-sm ${data.productCode ? 'auto-filled' : ''}" 
                                       value="${data.productCode}" id="productCode_${pageNumber}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-3"><strong>å“å:</strong></div>
                            <div class="col-sm-9">
                                <input type="text" class="form-control form-control-sm ${data.productName ? 'auto-filled' : ''}" 
                                       value="${data.productName}" id="productName_${pageNumber}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-3"><strong>æè³ª:</strong></div>
                            <div class="col-sm-9">
                                <input type="text" class="form-control form-control-sm ${data.material ? 'auto-filled' : ''}" 
                                       value="${data.material}" id="material_${pageNumber}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-3"><strong>å˜é‡é‡:</strong></div>
                            <div class="col-sm-9">
                                <input type="number" step="0.1" class="form-control form-control-sm ${data.unitWeight ? 'auto-filled' : ''}" 
                                       value="${data.unitWeight}" id="unitWeight_${pageNumber}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-3"><strong>æ•°é‡:</strong></div>
                            <div class="col-sm-9">
                                <input type="number" class="form-control form-control-sm ${data.quantity ? 'auto-filled' : ''}" 
                                       value="${data.quantity}" id="quantity_${pageNumber}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-3"><strong>ç™ºæ³¨æ—¥:</strong></div>
                            <div class="col-sm-9">
                                <input type="date" class="form-control form-control-sm ${data.orderDate ? 'auto-filled' : ''}" 
                                       value="${data.orderDate}" id="orderDate_${pageNumber}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-3"><strong>ç´æœŸ:</strong></div>
                            <div class="col-sm-9">
                                <input type="date" class="form-control form-control-sm ${data.deliveryDate ? 'auto-filled' : ''}" 
                                       value="${data.deliveryDate}" id="deliveryDate_${pageNumber}">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button class="btn btn-primary btn-sm me-2" 
                                        onclick="addOrderFromPage(${pageNumber})">
                                    ğŸ“ ã“ã®æ³¨æ–‡ã‚’ã‚·ã‚¹ãƒ†ãƒ ã«è¿½åŠ 
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" 
                                        onclick="clearPageData(${pageNumber})">
                                    ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ãƒšãƒ¼ã‚¸æ¦‚è¦è¡¨ç¤º
        function generatePageSummary(data, pageNumber) {
            const fieldsCount = Object.values(data).filter(val => val && val.toString().trim()).length;
            const totalFields = Object.keys(data).length - 1; // notesã‚’é™¤ã
            const completeness = Math.round((fieldsCount / totalFields) * 100);

            return `
                <div class="card bg-light">
                    <div class="card-header">
                        <h6 class="mb-0">ğŸ“Š ãƒšãƒ¼ã‚¸ ${pageNumber} æ¦‚è¦</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>ãƒ‡ãƒ¼ã‚¿å®Œæˆåº¦</span>
                                <span>${completeness}%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar ${completeness >= 70 ? 'bg-success' : completeness >= 40 ? 'bg-warning' : 'bg-danger'}" 
                                     style="width: ${completeness}%"></div>
                            </div>
                        </div>
                        <div class="small">
                            <div class="mb-1">
                                ${data.orderNumber ? 'âœ…' : 'âŒ'} æ³¨æ–‡ç•ªå·
                            </div>
                            <div class="mb-1">
                                ${data.productCode ? 'âœ…' : 'âŒ'} å“ç•ª
                            </div>
                            <div class="mb-1">
                                ${data.productName ? 'âœ…' : 'âŒ'} å“å
                            </div>
                            <div class="mb-1">
                                ${data.material ? 'âœ…' : 'âŒ'} æè³ª
                            </div>
                            <div class="mb-1">
                                ${data.unitWeight ? 'âœ…' : 'âŒ'} å˜é‡é‡
                            </div>
                            <div class="mb-1">
                                ${data.orderDate ? 'âœ…' : 'âŒ'} ç™ºæ³¨æ—¥
                            </div>
                            <div class="mb-1">
                                ${data.deliveryDate ? 'âœ…' : 'âŒ'} ç´æœŸ
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ³¨æ–‡è¿½åŠ 
        function addOrderFromPage(pageNumber) {
            const data = {
                orderNumber: document.getElementById(`orderNumber_${pageNumber}`)?.value || '',
                customer: document.getElementById(`customer_${pageNumber}`)?.value || '',
                productCode: document.getElementById(`productCode_${pageNumber}`)?.value || '',
                productName: document.getElementById(`productName_${pageNumber}`)?.value || '',
                material: document.getElementById(`material_${pageNumber}`)?.value || '',
                unitWeight: parseFloat(document.getElementById(`unitWeight_${pageNumber}`)?.value) || 0,
                quantity: parseInt(document.getElementById(`quantity_${pageNumber}`)?.value) || 0,
                orderDate: document.getElementById(`orderDate_${pageNumber}`)?.value || '',
                deliveryDate: document.getElementById(`deliveryDate_${pageNumber}`)?.value || ''
            };

            // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
            if (!data.orderNumber || !data.productCode || !data.productName) {
                alert('æ³¨æ–‡ç•ªå·ã€å“ç•ªã€å“åã¯å¿…é ˆé …ç›®ã§ã™ã€‚');
                return;
            }

            // æ³¨æ–‡ã‚’ã‚·ã‚¹ãƒ†ãƒ ã«è¿½åŠ ï¼ˆæ—¢å­˜ã®addOrderé–¢æ•°ã‚’ä½¿ç”¨ï¼‰
            addOrder(data);
            
            alert(`ãƒšãƒ¼ã‚¸ ${pageNumber} ã®æ³¨æ–‡ãŒæ­£å¸¸ã«è¿½åŠ ã•ã‚Œã¾ã—ãŸï¼`);
        }

        // ãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearPageData(pageNumber) {
            if (confirm(`ãƒšãƒ¼ã‚¸ ${pageNumber} ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ`)) {
                const inputs = document.querySelectorAll(`#page${pageNumber} input`);
                inputs.forEach(input => {
                    input.value = '';
                    input.classList.remove('auto-filled');
                });
            }
        }

        // æ”¹å–„ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ è‡ªå‹•å…¥åŠ›æ©Ÿèƒ½
        function populateExtractedData(data) {
            console.log('=== ãƒ•ã‚©ãƒ¼ãƒ è‡ªå‹•å…¥åŠ›é–‹å§‹ ===');
            
            // æŠ½å‡ºãƒ‡ãƒ¼ã‚¿ã®å“è³ªè©•ä¾¡
            const dataQuality = evaluateDataQuality(data);
            console.log('ãƒ‡ãƒ¼ã‚¿å“è³ªè©•ä¾¡:', dataQuality);

            // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©ï¼ˆé‡é‡ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«å¤‰æ›´ï¼‰
            const fieldMappings = [
                { id: 'pdfOrderNumber', value: data.orderNumber, label: 'æ³¨æ–‡ç•ªå·', required: true },
                { id: 'pdfCustomer', value: data.customer, label: 'ç™ºæ³¨è€…', required: false },
                { id: 'pdfProductCode', value: data.productCode, label: 'å“ç•ª', required: true },
                { id: 'pdfProductName', value: data.productName, label: 'å“å', required: true },
                { id: 'pdfMaterial', value: data.material, label: 'æè³ª', required: true },
                { id: 'pdfUnitWeight', value: data.unitWeight, label: 'å˜é‡é‡', required: false }, // é‡é‡ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«å¤‰æ›´
                { id: 'pdfQuantity', value: data.quantity, label: 'æ•°é‡', required: true },
                { id: 'pdfDeliveryDate', value: data.deliveryDate, label: 'ç´æœŸ', required: true },
                { id: 'pdfNotes', value: data.notes, label: 'å‚™è€ƒ', required: false }
            ];

            // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
            let filledCount = 0;
            let requiredFilledCount = 0;
            let totalRequiredCount = 0;

            fieldMappings.forEach(mapping => {
                const element = document.getElementById(mapping.id);
                if (element) {
                    // æ—¢å­˜å€¤ã®ã‚¯ãƒªã‚¢
                    element.value = '';
                    element.classList.remove('is-valid', 'is-invalid', 'auto-filled');

                    if (mapping.value !== null && mapping.value !== undefined && mapping.value !== '') {
                        // å€¤ã®è¨­å®š
                        element.value = mapping.value;
                        filledCount++;
                        
                        // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¿½åŠ 
                        element.classList.add('auto-filled');
                        
                        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
                        if (validateFieldValue(mapping.id, mapping.value)) {
                            element.classList.add('is-valid');
                        } else {
                            element.classList.add('is-invalid');
                        }

                        if (mapping.required) {
                            requiredFilledCount++;
                        }

                        console.log(`âœ“ ${mapping.label}: "${mapping.value}"`);
                    } else {
                        console.log(`âœ— ${mapping.label}: æœªæŠ½å‡º`);
                        if (mapping.required) {
                            element.classList.add('is-invalid');
                        }
                    }

                    if (mapping.required) {
                        totalRequiredCount++;
                    }
                }
            });

            // ç·é‡é‡ã®è‡ªå‹•è¨ˆç®—
            calculateTotalWeight();

            // æŠ½å‡ºçµæœã‚µãƒãƒªãƒ¼è¡¨ç¤º
            showExtractionSummary(filledCount, requiredFilledCount, totalRequiredCount, dataQuality);

            // ãƒ•ã‚©ãƒ¼ãƒ çŠ¶æ…‹ã®æ›´æ–°
            updateFormState(requiredFilledCount, totalRequiredCount);

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã®æ›´æ–°
            updateDataPreview(data, dataQuality);

            console.log(`=== ãƒ•ã‚©ãƒ¼ãƒ è‡ªå‹•å…¥åŠ›å®Œäº† ===`);
            console.log(`å…¥åŠ›é …ç›®: ${filledCount}/9`);
            console.log(`å¿…é ˆé …ç›®: ${requiredFilledCount}/${totalRequiredCount}`);
        }

        // ãƒ‡ãƒ¼ã‚¿å“è³ªè©•ä¾¡é–¢æ•°
        function evaluateDataQuality(data) {
            const quality = {
                score: 0,
                maxScore: 8,
                details: {},
                level: '',
                color: ''
            };

            // å„é …ç›®ã®å“è³ªè©•ä¾¡
            const evaluations = [
                { key: 'orderNumber', weight: 2, check: (val) => val && val.length >= 3 },
                { key: 'customer', weight: 1, check: (val) => val && val.length >= 2 },
                { key: 'productCode', weight: 2, check: (val) => val && /[A-Z0-9\-]/.test(val) },
                { key: 'productName', weight: 1, check: (val) => val && val.length >= 2 },
                { key: 'material', weight: 1, check: (val) => val && val.length >= 2 },
                { key: 'unitWeight', weight: 1, check: (val) => val && val > 0 },
                { key: 'quantity', weight: 1, check: (val) => val && val > 0 },
                { key: 'deliveryDate', weight: 1, check: (val) => val && new Date(val).getTime() > Date.now() }
            ];

            evaluations.forEach(eval => {
                const value = data[eval.key];
                const isValid = eval.check(value);
                quality.details[eval.key] = {
                    valid: isValid,
                    value: value,
                    weight: eval.weight
                };
                if (isValid) {
                    quality.score += eval.weight;
                }
            });

            // å“è³ªãƒ¬ãƒ™ãƒ«åˆ¤å®š
            const percentage = (quality.score / quality.maxScore) * 100;
            if (percentage >= 80) {
                quality.level = 'å„ªç§€';
                quality.color = 'success';
            } else if (percentage >= 60) {
                quality.level = 'è‰¯å¥½';
                quality.color = 'info';
            } else if (percentage >= 40) {
                quality.level = 'æ™®é€š';
                quality.color = 'warning';
            } else {
                quality.level = 'è¦ç¢ºèª';
                quality.color = 'danger';
            }

            return quality;
        }

        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateFieldValue(fieldId, value) {
            switch (fieldId) {
                case 'pdfOrderNumber':
                    return value && value.toString().length >= 3;
                case 'pdfProductCode':
                    return value && /[A-Z0-9\-]/.test(value);
                case 'pdfProductName':
                    return value && value.toString().length >= 2;
                case 'pdfMaterial':
                    return value && value.toString().length >= 2;
                case 'pdfUnitWeight':
                    return value && !isNaN(value) && parseFloat(value) > 0;
                case 'pdfQuantity':
                    return value && !isNaN(value) && parseInt(value) > 0;
                case 'pdfDeliveryDate':
                    return value && new Date(value).getTime() > Date.now() - (24 * 60 * 60 * 1000);
                default:
                    return true;
            }
        }

        // ç·é‡é‡ã®è‡ªå‹•è¨ˆç®—
        function calculateTotalWeight() {
            const unitWeight = parseFloat(document.getElementById('pdfUnitWeight')?.value) || 0;
            const quantity = parseInt(document.getElementById('pdfQuantity')?.value) || 0;
            const totalWeight = unitWeight * quantity;

            // ç·é‡é‡è¡¨ç¤ºã‚¨ãƒªã‚¢ã®æ›´æ–°ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
            const totalWeightDisplay = document.getElementById('pdfTotalWeight');
            if (totalWeightDisplay) {
                totalWeightDisplay.textContent = totalWeight.toFixed(1) + 'kg';
            }

            return totalWeight;
        }

        // æŠ½å‡ºçµæœã‚µãƒãƒªãƒ¼è¡¨ç¤º
        function showExtractionSummary(filledCount, requiredFilledCount, totalRequiredCount, dataQuality) {
            // ã‚µãƒãƒªãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ä½œæˆ/æ›´æ–°
            let summaryElement = document.getElementById('extractionSummary');
            if (!summaryElement) {
                summaryElement = document.createElement('div');
                summaryElement.id = 'extractionSummary';
                summaryElement.className = 'alert mt-3';
                
                // æŠ½å‡ºãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å‰ã«æŒ¿å…¥
                const extractedTextCard = document.querySelector('#extractedText').closest('.card');
                extractedTextCard.parentNode.insertBefore(summaryElement, extractedTextCard);
            }

            const percentage = Math.round((dataQuality.score / dataQuality.maxScore) * 100);
            
            summaryElement.className = `alert alert-${dataQuality.color} mt-3`;
            summaryElement.innerHTML = `
                <h6><i class="bi bi-clipboard-data"></i> æŠ½å‡ºçµæœã‚µãƒãƒªãƒ¼</h6>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>å…¥åŠ›é …ç›®:</strong> ${filledCount}/9 é …ç›®</p>
                        <p class="mb-1"><strong>å¿…é ˆé …ç›®:</strong> ${requiredFilledCount}/${totalRequiredCount} é …ç›®</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>ãƒ‡ãƒ¼ã‚¿å“è³ª:</strong> 
                            <span class="badge bg-${dataQuality.color}">${dataQuality.level}</span> 
                            (${percentage}%)
                        </p>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-${dataQuality.color}" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                </div>
                ${requiredFilledCount < totalRequiredCount ? 
                    '<small class="text-muted"><i class="bi bi-exclamation-triangle"></i> æœªå…¥åŠ›ã®å¿…é ˆé …ç›®ãŒã‚ã‚Šã¾ã™ã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</small>' : 
                    '<small class="text-success"><i class="bi bi-check-circle"></i> ã™ã¹ã¦ã®å¿…é ˆé …ç›®ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã™ã€‚</small>'
                }
            `;
        }

        // ãƒ•ã‚©ãƒ¼ãƒ çŠ¶æ…‹ã®æ›´æ–°
        function updateFormState(requiredFilledCount, totalRequiredCount) {
            const addButton = document.getElementById('addFromPDFBtn');
            if (addButton) {
                const canSubmit = requiredFilledCount === totalRequiredCount;
                addButton.disabled = !canSubmit;
                
                if (canSubmit) {
                    addButton.innerHTML = '<i class="bi bi-plus-circle"></i> æ³¨æ–‡ã¨ã—ã¦è¿½åŠ ';
                    addButton.className = 'btn btn-success';
                } else {
                    addButton.innerHTML = '<i class="bi bi-exclamation-triangle"></i> å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                    addButton.className = 'btn btn-warning';
                }
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        function updateDataPreview(data, dataQuality) {
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã®ä½œæˆ/æ›´æ–°
            let previewElement = document.getElementById('dataPreview');
            if (!previewElement) {
                previewElement = document.createElement('div');
                previewElement.id = 'dataPreview';
                previewElement.className = 'mt-3';
                
                // æŠ½å‡ºãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒ ã®å¾Œã«æŒ¿å…¥
                const formContainer = document.getElementById('extractedDataContainer');
                formContainer.appendChild(previewElement);
            }

            const totalWeight = calculateTotalWeight();
            const isComplete = Object.values(data).filter(v => v !== null && v !== undefined && v !== '').length >= 6;

            previewElement.innerHTML = `
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="bi bi-eye"></i> ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-sm">
                                    <tr><th>æ³¨æ–‡ç•ªå·:</th><td>${data.orderNumber || 'æœªå…¥åŠ›'}</td></tr>
                                    <tr><th>ç™ºæ³¨è€…:</th><td>${data.customer || 'æœªå…¥åŠ›'}</td></tr>
                                    <tr><th>å“ç•ª:</th><td>${data.productCode || 'æœªå…¥åŠ›'}</td></tr>
                                    <tr><th>å“å:</th><td>${data.productName || 'æœªå…¥åŠ›'}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-sm">
                                    <tr><th>æè³ª:</th><td>${data.material || 'æœªå…¥åŠ›'}</td></tr>
                                    <tr><th>å˜é‡é‡:</th><td>${data.unitWeight ? data.unitWeight + 'kg' : 'æœªå…¥åŠ›'}</td></tr>
                                    <tr><th>æ•°é‡:</th><td>${data.quantity || 'æœªå…¥åŠ›'}</td></tr>
                                    <tr><th>ç·é‡é‡:</th><td class="fw-bold text-primary">${totalWeight > 0 ? totalWeight.toFixed(1) + 'kg' : 'æœªè¨ˆç®—'}</td></tr>
                                </table>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <table class="table table-sm">
                                    <tr><th>ç´æœŸ:</th><td>${data.deliveryDate || 'æœªå…¥åŠ›'}</td></tr>
                                    <tr><th>å‚™è€ƒ:</th><td>${data.notes || '(ãªã—)'}</td></tr>
                                </table>
                            </div>
                        </div>
                        <div class="text-center">
                            ${isComplete ? 
                                '<span class="badge bg-success"><i class="bi bi-check-circle"></i> ç™»éŒ²æº–å‚™å®Œäº†</span>' : 
                                '<span class="badge bg-warning"><i class="bi bi-pencil"></i> æ‰‹å‹•å…¥åŠ›ãŒå¿…è¦</span>'
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ç›£è¦–ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼‰
        function setupFormWatchers() {
            const watchFields = ['pdfOrderNumber', 'pdfCustomer', 'pdfProductCode', 'pdfProductName', 
                               'pdfMaterial', 'pdfUnitWeight', 'pdfQuantity', 'pdfDeliveryDate', 'pdfNotes'];
            
            watchFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('input', function() {
                        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                        const isValid = validateFieldValue(fieldId, this.value);
                        this.classList.remove('is-valid', 'is-invalid');
                        if (this.value) {
                            this.classList.add(isValid ? 'is-valid' : 'is-invalid');
                        }

                        // é‡é‡è¨ˆç®—ã®æ›´æ–°
                        if (fieldId === 'pdfUnitWeight' || fieldId === 'pdfQuantity') {
                            calculateTotalWeight();
                        }

                        // ãƒ•ã‚©ãƒ¼ãƒ çŠ¶æ…‹ã®æ›´æ–°
                        updateFormStatusRealtime();
                    });
                }
            });
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ•ã‚©ãƒ¼ãƒ çŠ¶æ…‹æ›´æ–°
        function updateFormStatusRealtime() {
            const requiredFields = ['pdfOrderNumber', 'pdfProductCode', 'pdfProductName', 
                                  'pdfMaterial', 'pdfUnitWeight', 'pdfQuantity', 'pdfDeliveryDate'];
            
            let requiredFilledCount = 0;
            requiredFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element && element.value && validateFieldValue(fieldId, element.value)) {
                    requiredFilledCount++;
                }
            });

            updateFormState(requiredFilledCount, requiredFields.length);
        }

        // PDFæ³¨æ–‡è¿½åŠ 
        function addOrderFromPDF() {
            const orderNumber = document.getElementById('pdfOrderNumber')?.value.trim() || '';
            const customer = document.getElementById('pdfCustomer')?.value.trim() || '';
            const productCode = document.getElementById('pdfProductCode')?.value.trim() || '';
            const productName = document.getElementById('pdfProductName')?.value.trim() || '';
            const material = document.getElementById('pdfMaterial')?.value || '';
            const unitWeight = parseFloat(document.getElementById('pdfUnitWeight')?.value) || 0;
            const quantity = parseInt(document.getElementById('pdfQuantity')?.value) || 0;
            const deliveryDate = document.getElementById('pdfDeliveryDate')?.value || '';
            const notes = document.getElementById('pdfNotes')?.value.trim() || '';

            if (!orderNumber || !productCode || !productName || !material || !unitWeight || !quantity || !deliveryDate) {
                alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const newOrder = {
                id: 'PDF-' + Date.now(),
                orderNumber: orderNumber,
                customer: customer,
                productCode: productCode,
                productName: productName,
                material: material,
                unitWeight: unitWeight,
                quantity: quantity,
                totalWeight: unitWeight * quantity,
                deliveryDate: deliveryDate,
                status: 'pending',
                notes: notes + (notes ? '\n' : '') + '[PDFå–è¾¼]'
            };

            orders.push(newOrder);
            filteredOrders = [...orders];
            
            if (typeof saveData === 'function') saveData();
            if (typeof updateDashboard === 'function') updateDashboard();
            if (typeof updateTable === 'function') updateTable();

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            const modal = bootstrap.Modal.getInstance(document.getElementById('pdfModal'));
            if (modal) modal.hide();

            alert(`æ³¨æ–‡ "${orderNumber}" ã‚’PDFã‹ã‚‰æ­£å¸¸ã«è¿½åŠ ã—ã¾ã—ãŸã€‚`);
        }
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="bi bi-gear-fill"></i> ã‚¹ãƒ†ãƒ³ãƒ¬ã‚¹é‹³é€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </a>
            <span class="navbar-text"><i class="bi bi-circle-fill text-success"></i> ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒä¸­</span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-success" onclick="showAddOrderModal()"><i class="bi bi-plus-circle"></i> æ–°è¦æ³¨æ–‡è¿½åŠ </button>
                    <button class="btn btn-warning" onclick="showPDFModal()"><i class="bi bi-file-pdf"></i> PDFèª­ã¿å–ã‚Š</button>
                    <button class="btn btn-info" onclick="showExcelModal()"><i class="bi bi-file-spreadsheet"></i> Excelå–è¾¼</button>
                    <button class="btn btn-secondary" onclick="exportToCSV()"><i class="bi bi-download"></i> CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button class="btn btn-primary" onclick="runBatchOptimization()"><i class="bi bi-lightning"></i> ãƒãƒƒãƒæœ€é©åŒ–</button>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body"><h5>æœªå®Œäº†æ³¨æ–‡æ•°</h5><h2 id="orderCount">0</h2></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-info text-white">
                    <div class="card-body"><h5>ç·é‡é‡</h5><h2 id="totalWeight">0 kg</h2></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-warning text-white">
                    <div class="card-body"><h5>ç·Šæ€¥ç´æœŸä»¶æ•°</h5><h2 id="urgentCount">0</h2></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-success text-white">
                    <div class="card-body"><h5>æ¨å¥¨ãƒãƒƒãƒæ•°</h5><h2 id="batchCount">0</h2></div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header"><h5><i class="bi bi-funnel"></i> ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»æ¤œç´¢</h5></div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <select class="form-select" id="materialFilter" onchange="applyFilters()">
                                    <option value="">å…¨æè³ª</option>
                                    <option value="S14">S14</option>
                                    <option value="SCS">SCS</option>
                                    <option value="SUS304">SUS304</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="statusFilter" onchange="applyFilters()">
                                    <option value="">å…¨çŠ¶æ…‹</option>
                                    <option value="pending">æœªå‡¦ç†</option>
                                    <option value="processing">å‡¦ç†ä¸­</option>
                                    <option value="completed">å®Œäº†</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="searchBox" placeholder="å“åãƒ»å“ç•ªã§æ¤œç´¢..." onkeyup="applyFilters()">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()"><i class="bi bi-x-circle"></i> ã‚¯ãƒªã‚¢</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header"><h5><i class="bi bi-robot"></i> AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h5></div>
                    <div class="card-body">
                        <div id="chatContainer" class="chat-container mb-3">
                            <div class="message-ai">ã“ã‚“ã«ã¡ã¯ï¼ã€ŒS14æã‚’è¡¨ç¤ºã€ã€Œç·Šæ€¥ã®æ³¨æ–‡ã¯ï¼Ÿã€ãªã©ãŠèããã ã•ã„ã€‚</div>
                        </div>
                        <div class="mb-2">
                            <textarea class="form-control" id="chatInput" rows="3" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...ä¾‹ï¼š'S14æã®æ³¨æ–‡ã‚’è¡¨ç¤º'ã€'ç·Šæ€¥ã®æ³¨æ–‡ã¯ï¼Ÿ'" onkeypress="handleChatKeyPress(event)"></textarea>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="insertQuickQuery('S14æã‚’è¡¨ç¤º')">S14æ</button>
                                <button class="btn btn-outline-secondary" onclick="insertQuickQuery('ç·Šæ€¥ã®æ³¨æ–‡ã¯ï¼Ÿ')">ç·Šæ€¥</button>
                                <button class="btn btn-outline-secondary" onclick="insertQuickQuery('ç·é‡é‡ã‚’æ•™ãˆã¦')">é‡é‡</button>
                            </div>
                            <button class="btn btn-primary" onclick="sendChatMessage()" id="sendButton">
                                <i class="bi bi-send"></i> é€ä¿¡
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-table"></i> æ³¨æ–‡ç®¡ç†ä¸€è¦§</h5>
                <span class="badge bg-primary" id="displayCount">0ä»¶è¡¨ç¤º</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th onclick="sortTable('customer')">ç™ºæ³¨è€… <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('orderNumber')">æ³¨æ–‡ç•ªå· <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('productCode')">å“ç•ª <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('productName')">å“å <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('material')">æè³ª <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('unitWeight')">å˜é‡é‡ <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('quantity')">æ•°é‡ <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('totalWeight')">ç·é‡é‡ <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('orderDate')">ç™ºæ³¨æ—¥ <i class="bi bi-arrow-down-up"></i></th>
                                <th onclick="sortTable('deliveryDate')">ç´æœŸ <i class="bi bi-arrow-down-up"></i></th>
                                <th>çŠ¶æ…‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«å„ç¨® -->
    <div class="modal fade" id="addOrderModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ–°è¦æ³¨æ–‡è¿½åŠ </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addOrderForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">æ³¨æ–‡ç•ªå· *</label>
                                    <input type="text" class="form-control" id="newOrderNumber" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ç™ºæ³¨è€…</label>
                                    <input type="text" class="form-control" id="newCustomer" placeholder="å–å¼•å…ˆåã‚’å…¥åŠ›">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">å“ç•ª *</label>
                                    <input type="text" class="form-control" id="newProductCode" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">å“å *</label>
                                    <input type="text" class="form-control" id="newProductName" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">æè³ª *</label>
                                    <select class="form-select" id="newMaterial" required>
                                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                        <option value="S13">S13</option>
                                        <option value="S14">S14</option>
                                        <option value="S15">S15</option>
                                        <option value="SCS13">SCS13</option>
                                        <option value="SCS14">SCS14</option>
                                        <option value="SUS304">SUS304</option>
                                        <option value="SUS316">SUS316</option>
                                        <option value="FC200">FC200</option>
                                        <option value="FC250">FC250</option>
                                        <option value="FC300">FC300</option>
                                        <option value="FC400">FC400</option>
                                        <option value="FCD400">FCD400</option>
                                        <option value="FCD450">FCD450</option>
                                        <option value="FCD500">FCD500</option>
                                        <option value="SCPH1">SCPH1</option>
                                        <option value="SCPH2">SCPH2</option>
                                        <option value="SCPH11">SCPH11</option>
                                        <option value="SCPH12">SCPH12</option>
                                        <option value="SCPH13">SCPH13</option>
                                        <option value="ãã®ä»–">ãã®ä»–ï¼ˆæ‰‹å…¥åŠ›ï¼‰</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">å˜é‡é‡ (kg) *</label>
                                    <input type="number" class="form-control" id="newUnitWeight" step="0.1" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">æ•°é‡ *</label>
                                    <input type="number" class="form-control" id="newQuantity" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ç™ºæ³¨æ—¥</label>
                                    <input type="date" class="form-control" id="newOrderDate">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ç´æœŸ *</label>
                                    <input type="date" class="form-control" id="newDeliveryDate" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å‚™è€ƒ</label>
                            <textarea class="form-control" id="newNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-success" onclick="saveNewOrder()"><i class="bi bi-check-circle"></i> è¿½åŠ </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDFèª­ã¿è¾¼ã¿ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="pdfModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-file-pdf text-danger"></i> PDFèª­ã¿è¾¼ã¿ãƒ»ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- PDF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰éƒ¨åˆ† -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6><i class="bi bi-upload"></i> PDFãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="pdfFileInput" class="form-label">PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                                        <input type="file" class="form-control" id="pdfFileInput" accept=".pdf" onchange="handlePDFFileSelect(event)">
                                        <div class="form-text">
                                            æ³¨æ–‡æ›¸ãƒ»ä»•æ§˜æ›¸ãªã©ã®PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„
                                        </div>
                                    </div>
                                    
                                    <div id="pdfProcessingStatus" class="alert alert-info d-none">
                                        <i class="bi bi-hourglass-split"></i> PDFã‚’è§£æä¸­...
                                    </div>
                                    
                                    <div id="pdfPreview" class="border rounded p-3 bg-light d-none">
                                        <h6>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h6>
                                        <canvas id="pdfCanvas" class="w-100"></canvas>
                                        <div class="mt-2">
                                            <small class="text-muted">ãƒšãƒ¼ã‚¸: <span id="pdfPageInfo">-</span></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æŠ½å‡ºãƒ‡ãƒ¼ã‚¿éƒ¨åˆ† -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6><i class="bi bi-table"></i> æŠ½å‡ºãƒ‡ãƒ¼ã‚¿</h6>
                                </div>
                                <div class="card-body">
                                    <div id="extractedDataContainer" class="d-none">
                                        <form id="pdfExtractedForm">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-2">
                                                        <label class="form-label">æ³¨æ–‡ç•ªå·</label>
                                                        <input type="text" class="form-control form-control-sm" id="pdfOrderNumber">
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-2">
                                                        <label class="form-label">ç™ºæ³¨è€…</label>
                                                        <input type="text" class="form-control form-control-sm" id="pdfCustomer">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-2">
                                                        <label class="form-label">å“ç•ª</label>
                                                        <input type="text" class="form-control form-control-sm" id="pdfProductCode">
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-2">
                                                        <label class="form-label">å“å</label>
                                                        <input type="text" class="form-control form-control-sm" id="pdfProductName">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="mb-2">
                                                        <label class="form-label">æè³ª</label>
                                                        <select class="form-select form-select-sm" id="pdfMaterial">
                                                            <option value="">é¸æŠ</option>
                                                            <option value="S14">S14</option>
                                                            <option value="SCS">SCS</option>
                                                            <option value="SUS304">SUS304</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="mb-2">
                                                        <label class="form-label">å˜é‡é‡(kg)</label>
                                                        <input type="number" class="form-control form-control-sm" id="pdfUnitWeight" step="0.1">
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="mb-2">
                                                        <label class="form-label">æ•°é‡</label>
                                                        <input type="number" class="form-control form-control-sm" id="pdfQuantity">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label">ç´æœŸ</label>
                                                <input type="date" class="form-control form-control-sm" id="pdfDeliveryDate">
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label">å‚™è€ƒ</label>
                                                <textarea class="form-control form-control-sm" id="pdfNotes" rows="2"></textarea>
                                            </div>
                                        </form>
                                    </div>
                                    
                                    <div id="noDataMessage" class="text-center text-muted">
                                        <i class="bi bi-file-text fs-1"></i>
                                        <p>PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ãŒè‡ªå‹•æŠ½å‡ºã•ã‚Œã¾ã™</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æŠ½å‡ºã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰ -->
                    <div class="mt-3">
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="bi bi-code"></i> æŠ½å‡ºãƒ†ã‚­ã‚¹ãƒˆï¼ˆç¢ºèªç”¨ï¼‰</h6>
                            </div>
                            <div class="card-body">
                                <textarea id="extractedText" class="form-control" rows="4" readonly placeholder="PDFã‹ã‚‰æŠ½å‡ºã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button type="button" class="btn btn-primary" onclick="addOrderFromPDF()" id="addFromPDFBtn" disabled>
                        <i class="bi bi-plus-circle"></i> æ³¨æ–‡ã¨ã—ã¦è¿½åŠ 
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // === å®Œå…¨å®Ÿè£…ã‚·ã‚¹ãƒ†ãƒ  ===
        const GOOGLE_AI_CONFIG = {
            apiKey: 'AIzaSyAL3eoIyjELD7MsXHCZnA0y2CZe-NpjnNQ',
            endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent'
        };

        // OpenAI APIè¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ï¼‰
        const OPENAI_CONFIG = {
            apiKey: 'YOUR_OPENAI_API_KEY', // å®Ÿéš›ã®APIã‚­ãƒ¼ã«ç½®ãæ›ãˆã¦ãã ã•ã„
            endpoint: 'https://api.openai.com/v1/chat/completions',
            model: 'gpt-3.5-turbo'
        };

        // Claude APIè¨­å®šï¼ˆä»£æ›¿æ¡ˆï¼‰
        const CLAUDE_CONFIG = {
            apiKey: 'YOUR_CLAUDE_API_KEY', // å®Ÿéš›ã®APIã‚­ãƒ¼ã«ç½®ãæ›ãˆã¦ãã ã•ã„
            endpoint: 'https://api.anthropic.com/v1/messages',
            model: 'claude-3-sonnet-20240229'
        };

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®åˆæœŸåŒ–
        orders = JSON.parse(localStorage.getItem('castingOrders') || '[]');
        filteredOrders = [...orders];


        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
        if (orders.length === 0) {
            orders = [
                {
                    id: 'MN002BUV',
                    orderNumber: 'MN002BUV',
                    customer: 'æ ªå¼ä¼šç¤¾ç”°ä¸­è£½ä½œæ‰€',
                    productCode: 'P815-110-0162',
                    productName: 'ã‚³ãƒã‚¯ã‚¿ VLN-15',
                    material: 'S14',
                    unitWeight: 13.2,
                    quantity: 2,
                    totalWeight: 26.4,
                    orderDate: '2025-01-10',
                    deliveryDate: '2025-01-31',
                    status: 'pending',
                    notes: '25.4.9åœ¨åº«3ã‚±ä»•ä¸Šæ¸ˆ'
                },
                {
                    id: 'MH002BVD',
                    orderNumber: 'MH002BVD',
                    customer: 'ä½è—¤å·¥æ¥­æ ªå¼ä¼šç¤¾',
                    productCode: 'P895-110-0163',
                    productName: 'ã‚³ãƒã‚¯ã‚¿ VLN-5',
                    material: 'FCD450',
                    unitWeight: 7.3,
                    quantity: 16,
                    totalWeight: 116.8,
                    orderDate: '2025-01-15',
                    deliveryDate: '2025-02-28',
                    status: 'pending',
                    notes: ''
                },
                {
                    id: 'FL003CVX',
                    orderNumber: 'FL003CVX',
                    customer: 'å±±ç”°æ©Ÿæ¢°å·¥æ¥­',
                    productCode: 'P920-150-0045',
                    productName: 'ãƒ•ãƒ©ãƒ³ã‚¸ CF-8',
                    material: 'SCPH2',
                    unitWeight: 25.4,
                    quantity: 8,
                    totalWeight: 203.2,
                    orderDate: '2025-01-12',
                    deliveryDate: '2025-02-15',
                    status: 'processing',
                    notes: 'ç‰¹æ€¥æ¡ˆä»¶'
                }
            ];
            saveData();
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            filteredOrders = [...orders];
            updateDashboard();
            updateTable();
            console.log('ã‚¹ãƒ†ãƒ³ãƒ¬ã‚¹é‹³é€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨ç‰ˆ èµ·å‹•å®Œäº†');
        });

        function saveData() {
            localStorage.setItem('castingOrders', JSON.stringify(orders));
        }

        function updateDashboard() {
            const pendingOrders = orders.filter(o => o.status === 'pending');
            const totalWeight = orders.reduce((sum, order) => sum + (order.totalWeight || 0), 0);

            const urgentOrders = orders.filter(order => {
                const deliveryDate = new Date(order.deliveryDate);
                const today = new Date();
                const daysDiff = (deliveryDate - today) / (1000 * 60 * 60 * 24);
                return daysDiff <= 7 && order.status !== 'completed';
            });

            document.getElementById('orderCount').textContent = pendingOrders.length;
            document.getElementById('totalWeight').textContent = totalWeight.toFixed(1) + ' kg';
            document.getElementById('urgentCount').textContent = urgentOrders.length;
            document.getElementById('batchCount').textContent = Math.ceil(totalWeight / 300);
        }

        function updateTable() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';

            filteredOrders.forEach(order => {
                const row = document.createElement('tr');

                const deliveryDate = new Date(order.deliveryDate);
                const today = new Date();
                const daysDiff = (deliveryDate - today) / (1000 * 60 * 60 * 24);
                const isUrgent = daysDiff <= 7 && order.status !== 'completed';

                if (isUrgent) row.classList.add('urgent-row');

                if (order.material === 'S14') row.classList.add('s14-material');
                else if (order.material === 'SCS') row.classList.add('scs-material');
                else if (order.material === 'SUS304') row.classList.add('sus304-material');

                const statusBadge = getStatusBadge(order.status);
                const materialClass = `material-${order.material.toLowerCase()}`;

                row.innerHTML = `
                    <td>${order.customer || '-'}</td>
                    <td>${order.orderNumber}</td>
                    <td>${order.productCode}</td>
                    <td>${order.productName}</td>
                    <td><span class="${materialClass}">${order.material}</span></td>
                    <td>${order.unitWeight}kg</td>
                    <td>${order.quantity}</td>
                    <td><strong>${order.totalWeight}kg</strong></td>
                    <td>${order.orderDate ? formatDate(order.orderDate) : '-'}</td>
                    <td>${formatDate(order.deliveryDate)} ${isUrgent ? '<i class="bi bi-exclamation-triangle text-danger"></i>' : ''}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editOrder('${order.id}')" title="ç·¨é›†">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteOrder('${order.id}')" title="å‰Šé™¤">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('displayCount').textContent = `${filteredOrders.length}ä»¶è¡¨ç¤º`;
        }

        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge bg-warning">æœªå‡¦ç†</span>',
                'processing': '<span class="badge bg-info">å‡¦ç†ä¸­</span>',
                'completed': '<span class="badge bg-success">å®Œäº†</span>'
            };
            return badges[status] || '<span class="badge bg-secondary">ä¸æ˜</span>';
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('ja-JP');
        }

        function applyFilters() {
            const materialFilter = document.getElementById('materialFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchText = document.getElementById('searchBox').value.toLowerCase();

            filteredOrders = orders.filter(order => {
                const materialMatch = !materialFilter || order.material === materialFilter;
                const statusMatch = !statusFilter || order.status === statusFilter;
                const searchMatch = !searchText ||
                    order.productName.toLowerCase().includes(searchText) ||
                    order.productCode.toLowerCase().includes(searchText) ||
                    order.orderNumber.toLowerCase().includes(searchText);

                return materialMatch && statusMatch && searchMatch;
            });

            updateTable();
        }

        function clearFilters() {
            document.getElementById('materialFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('searchBox').value = '';
            filteredOrders = [...orders];
            updateTable();
        }

        function sortTable(field) {
            filteredOrders.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];

                if (field === 'deliveryDate') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                } else if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
            });

            updateTable();
        }

        function showAddOrderModal() {
            const today = new Date();
            today.setDate(today.getDate() + 30);
            document.getElementById('newDeliveryDate').value = today.toISOString().split('T')[0];

            new bootstrap.Modal(document.getElementById('addOrderModal')).show();
        }

        function saveNewOrder() {
            const form = document.getElementById('addOrderForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const unitWeight = parseFloat(document.getElementById('newUnitWeight').value);
            const quantity = parseInt(document.getElementById('newQuantity').value);

            const newOrder = {
                id: 'ORD-' + Date.now(),
                orderNumber: document.getElementById('newOrderNumber').value,
                customer: document.getElementById('newCustomer').value || '',
                productCode: document.getElementById('newProductCode').value,
                productName: document.getElementById('newProductName').value,
                material: document.getElementById('newMaterial').value,
                unitWeight: unitWeight,
                quantity: quantity,
                totalWeight: unitWeight * quantity,
                orderDate: document.getElementById('newOrderDate').value || '',  // ç™ºæ³¨æ—¥ã‚’è¿½åŠ 
                deliveryDate: document.getElementById('newDeliveryDate').value,
                status: 'pending',
                notes: document.getElementById('newNotes').value
            };

            orders.push(newOrder);
            filteredOrders = [...orders];
            saveData();
            updateDashboard();
            updateTable();

            bootstrap.Modal.getInstance(document.getElementById('addOrderModal')).hide();
            form.reset();

            showNotification('æ–°è¦æ³¨æ–‡ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        }

        function editOrder(id) {
            const order = orders.find(o => o.id === id);
            if (!order) return;

            document.getElementById('newOrderNumber').value = order.orderNumber;
            document.getElementById('newCustomer').value = order.customer || '';
            document.getElementById('newProductCode').value = order.productCode;
            document.getElementById('newProductName').value = order.productName;
            document.getElementById('newMaterial').value = order.material;
            document.getElementById('newUnitWeight').value = order.unitWeight;
            document.getElementById('newQuantity').value = order.quantity;
            document.getElementById('newOrderDate').value = order.orderDate || '';
            document.getElementById('newDeliveryDate').value = order.deliveryDate;
            document.getElementById('newNotes').value = order.notes || '';

            deleteOrder(id, false);
            new bootstrap.Modal(document.getElementById('addOrderModal')).show();
        }

        function deleteOrder(id, showConfirm = true) {
            if (showConfirm && !confirm('ã“ã®æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            orders = orders.filter(o => o.id !== id);
            filteredOrders = filteredOrders.filter(o => o.id !== id);
            saveData();
            updateDashboard();
            updateTable();

            if (showConfirm) {
                showNotification('æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'info');
            }
        }


        function showExcelModal() {
            alert('Excelå–è¾¼æ©Ÿèƒ½ï¼šå®Ÿè£…å®Œäº†ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã¯çœç•¥ç‰ˆï¼‰');
        }

        // === ãã®ä»–ã®æ©Ÿèƒ½å®Ÿè£… ===
