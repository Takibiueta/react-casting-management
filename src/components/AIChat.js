import React, { useState } from 'react';
import { MessageCircle, Send, X, Bot } from 'lucide-react';

const AIChat = ({ orders, products, customers, onOrdersUpdate }) => {
  const [isOpen, setIsOpen] = useState(false);
  const [messages, setMessages] = useState([
    {
      id: '1',
      type: 'ai',
      content: '„Åì„Çì„Å´„Å°„ÅØÔºÅ„Çπ„ÉÜ„É≥„É¨„ÇπÈã≥ÈÄ†ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†„ÅÆAI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇü§ñ\n\n‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å™Ë≥™Âïè„Å´„ÅäÁ≠î„Åà„Åß„Åç„Åæ„ÅôÔºö\n‚Ä¢ "S14Êùê„ÇíË°®Á§∫" - ÁâπÂÆöÊùêË≥™„ÅÆÊ§úÁ¥¢\n‚Ä¢ "Á∑äÊÄ•„ÅÆÊ≥®Êñá„ÅØÔºü" - Á∑äÊÄ•Ê°à‰ª∂„ÅÆÁ¢∫Ë™ç\n‚Ä¢ "Á∑èÈáçÈáè„ÇíÊïô„Åà„Å¶" - Áµ±Ë®àÊÉÖÂ†±„ÅÆË°®Á§∫\n\n„ÅäÊ∞óËªΩ„Å´„ÅäËÅû„Åç„Åè„Å†„Åï„ÅÑÔºÅ',
      timestamp: new Date()
    }
  ]);
  const [inputMessage, setInputMessage] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const quickActions = [
    'S14ÊùêË≥™„ÅÆÊ≥®Êñá„ÇíË°®Á§∫',
    'SCSÊùêË≥™„ÅÆÊ≥®Êñá„ÇíË°®Á§∫', 
    '‰ªäÈÄ±‰∏≠„Å´Á¥çÊúü„ÅåÊù•„ÇãÊ≥®Êñá„ÇíÁ¢∫Ë™ç',
    'ÈÅÖÂª∂„Åó„Å¶„ÅÑ„ÇãÊ≥®Êñá„ÇíË°®Á§∫',
    'ÂÖ®Ê≥®Êñá„ÅÆÁµ±Ë®àÂàÜÊûê„Çí„Åó„Å¶'
  ];

  const handleSendMessage = async () => {
    if (!inputMessage.trim() || isLoading) return;

    const userMessage = {
      id: Date.now().toString(),
      type: 'user',
      content: inputMessage,
      timestamp: new Date()
    };

    setMessages(prev => [...prev, userMessage]);
    const currentInput = inputMessage;
    setInputMessage('');
    setIsLoading(true);

    try {
      // Simulate AI processing
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      let response = '';
      let filteredOrders = orders;

      // Simple AI logic based on keywords
      if (currentInput.toLowerCase().includes('s14')) {
        filteredOrders = orders.filter(order => order.material === 'S14');
        response = `S14ÊùêË≥™„ÅÆÊ≥®Êñá„Çí${filteredOrders.length}‰ª∂Ë¶ã„Å§„Åë„Åæ„Åó„Åü„ÄÇ\n\n`;
        filteredOrders.slice(0, 3).forEach((order, index) => {
          response += `${index + 1}. ${order.productName} - ${order.totalWeight}kg\n`;
        });
        onOrdersUpdate(filteredOrders);
      } else if (currentInput.toLowerCase().includes('scs')) {
        filteredOrders = orders.filter(order => order.material === 'SCS');
        response = `SCSÊùêË≥™„ÅÆÊ≥®Êñá„Çí${filteredOrders.length}‰ª∂Ë¶ã„Å§„Åë„Åæ„Åó„Åü„ÄÇ\n\n`;
        filteredOrders.slice(0, 3).forEach((order, index) => {
          response += `${index + 1}. ${order.productName} - ${order.totalWeight}kg\n`;
        });
        onOrdersUpdate(filteredOrders);
      } else if (currentInput.toLowerCase().includes('Á∑äÊÄ•') || currentInput.toLowerCase().includes('‰ªäÈÄ±')) {
        const today = new Date();
        filteredOrders = orders.filter(order => {
          const deliveryDate = new Date(order.deliveryDate);
          const daysDiff = Math.ceil((deliveryDate - today) / (1000 * 60 * 60 * 24));
          return daysDiff <= 7 && order.status !== 'completed';
        });
        response = `Á∑äÊÄ•Â∫¶„ÅÆÈ´ò„ÅÑÊ≥®Êñá„Çí${filteredOrders.length}‰ª∂Ë¶ã„Å§„Åë„Åæ„Åó„Åü„ÄÇ\n\n`;
        filteredOrders.forEach((order, index) => {
          const deliveryDate = new Date(order.deliveryDate);
          const daysDiff = Math.ceil((deliveryDate - today) / (1000 * 60 * 60 * 24));
          response += `${index + 1}. ${order.productName} - ÊÆã„Çä${daysDiff}Êó•\n`;
        });
        onOrdersUpdate(filteredOrders);
      } else if (currentInput.toLowerCase().includes('Áµ±Ë®à') || currentInput.toLowerCase().includes('ÂàÜÊûê')) {
        const totalWeight = orders.reduce((sum, order) => sum + order.totalWeight, 0);
        const urgentOrders = orders.filter(order => {
          const deliveryDate = new Date(order.deliveryDate);
          const today = new Date();
          const daysDiff = Math.ceil((deliveryDate - today) / (1000 * 60 * 60 * 24));
          return daysDiff <= 7 && order.status !== 'completed';
        });
        response = `üìä Ê≥®ÊñáÁµ±Ë®àÂàÜÊûêÁµêÊûúÔºö\n\n‚Ä¢ Á∑èÊ≥®ÊñáÊï∞: ${orders.length}‰ª∂\n‚Ä¢ Á∑èÈáçÈáè: ${totalWeight.toFixed(1)}kg\n‚Ä¢ Á∑äÊÄ•Ê°à‰ª∂: ${urgentOrders.length}‰ª∂\n‚Ä¢ Êé®Â•®„Éê„ÉÉ„ÉÅÊï∞: ${Math.ceil(totalWeight / 300)}`;
      } else {
        response = `„Äå${currentInput}„Äç„Å´„Å§„ÅÑ„Å¶Á¢∫Ë™ç„Åó„Åæ„Åó„Åü„ÄÇ\n\nÁèæÂú® ${orders.length}‰ª∂„ÅÆÊ≥®Êñá„ÇíÁÆ°ÁêÜ‰∏≠„Åß„Åô„ÄÇ\n\nüí° „Éí„É≥„ÉàÔºö\n‚Ä¢ "S14Êùê„ÇíË°®Á§∫"\n‚Ä¢ "Á∑äÊÄ•„ÅÆÊ≥®Êñá„ÅØÔºü"\n‚Ä¢ "Áµ±Ë®à„ÇíÊïô„Åà„Å¶"\n\n„Å™„Å©„Å®„ÅäËÅû„Åç„Åè„Å†„Åï„ÅÑ„ÄÇ`;
      }

      const aiMessage = {
        id: (Date.now() + 1).toString(),
        type: 'ai',
        content: response,
        timestamp: new Date()
      };

      setMessages(prev => [...prev, aiMessage]);

    } catch (error) {
      console.error('AIÂá¶ÁêÜ„Ç®„É©„Éº:', error);
      const errorMessage = {
        id: (Date.now() + 1).toString(),
        type: 'ai',
        content: 'Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ',
        timestamp: new Date()
      };
      setMessages(prev => [...prev, errorMessage]);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <>
      {/* AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Éú„Çø„É≥ */}
      <div className="fixed bottom-6 right-6 z-50">
        <button
          onClick={() => setIsOpen(!isOpen)}
          className={`w-16 h-16 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg ${
            isOpen 
              ? 'bg-red-500 hover:bg-red-600' 
              : 'bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 animate-pulse'
          }`}
        >
          {isOpen ? (
            <X className="w-6 h-6 text-white" />
          ) : (
            <div className="text-center text-white">
              <MessageCircle className="w-6 h-6 mx-auto" />
              <div className="text-xs mt-1">AI</div>
            </div>
          )}
        </button>
      </div>

      {/* AI„ÉÅ„É£„ÉÉ„Éà„Éë„Éç„É´ */}
      {isOpen && (
        <div className="fixed bottom-28 right-6 w-96 h-[32rem] bg-white rounded-lg shadow-2xl border z-40 flex flex-col">
          {/* „Éò„ÉÉ„ÉÄ„Éº */}
          <div className="flex items-center justify-between p-4 border-b bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-t-lg">
            <div className="flex items-center gap-2">
              <Bot className="w-5 h-5" />
              <span className="font-semibold">AI „Ç¢„Ç∑„Çπ„Çø„É≥„Éà</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
              <span className="text-xs">„Ç™„É≥„É©„Ç§„É≥</span>
            </div>
          </div>

          {/* „É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢ */}
          <div className="flex-1 overflow-y-auto p-4 space-y-3">
            {messages.map((message) => (
              <div
                key={message.id}
                className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}
              >
                <div
                  className={`max-w-[85%] p-3 rounded-lg ${
                    message.type === 'user'
                      ? 'bg-blue-500 text-white'
                      : 'bg-gradient-to-br from-purple-50 to-blue-50 text-gray-800 border border-purple-200'
                  }`}
                >
                  {message.type === 'ai' && (
                    <div className="flex items-center gap-1 mb-2 text-xs text-purple-600">
                      <Bot className="w-3 h-3" />
                      <span>AI</span>
                    </div>
                  )}
                  <div className="text-sm whitespace-pre-wrap leading-relaxed">{message.content}</div>
                  <div className="text-xs mt-1 opacity-50">
                    {message.timestamp.toLocaleTimeString()}
                  </div>
                </div>
              </div>
            ))}
            
            {isLoading && (
              <div className="flex justify-start">
                <div className="bg-gray-100 p-3 rounded-lg flex items-center gap-2">
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"></div>
                  <span className="text-sm text-gray-600">AIÊÄùËÄÉ‰∏≠...</span>
                </div>
              </div>
            )}
          </div>

          {/* „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Ç∑„Éß„É≥ */}
          <div className="p-3 border-t bg-gradient-to-r from-purple-50 to-blue-50">
            <div className="text-xs text-gray-600 mb-2">üí¨ Ë≥™Âïè‰æã:</div>
            <div className="flex flex-wrap gap-1">
              {quickActions.map((action, index) => (
                <button
                  key={index}
                  onClick={() => setInputMessage(action)}
                  className="text-xs bg-white hover:bg-purple-50 border rounded px-2 py-1 transition-colors hover:border-purple-300"
                >
                  {action}
                </button>
              ))}
            </div>
          </div>

          {/* ÂÖ•Âäõ„Ç®„É™„Ç¢ */}
          <div className="p-4 border-t">
            <div className="flex gap-2">
              <input
                type="text"
                value={inputMessage}
                onChange={(e) => setInputMessage(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                placeholder="Ë≥™Âïè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."
                className="flex-1 px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                disabled={isLoading}
              />
              <button
                onClick={handleSendMessage}
                disabled={isLoading || !inputMessage.trim()}
                className="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                <Send className="w-4 h-4" />
              </button>
            </div>
            <div className="text-xs text-gray-500 mt-1">
              ü§ñ AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà: Ëá™ÁÑ∂Ë®ÄË™û„ÅßË≥™ÂïèÂèØËÉΩ„Åß„Åô
            </div>
          </div>
        </div>
      )}
    </>
  );
};

export default AIChat;